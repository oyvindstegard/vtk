<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" 
                 "http://ibatis.apache.org/dtd/sql-map-2.dtd"> 

<sqlMap>
  
  <resultMap id="dataReportValueFrequency" class="java.util.HashMap">
    <result property="value" column="value" javaType="string" />
    <result property="frequency" column="frequency" javaType="int" />
  </resultMap>

  <!-- Parameters: 
        - namespace (String or null) property name space
        - name (String) property name
        - limit (Integer or null) result limit in rows
        - uriWildcard (String or null) uri wildcard string (for scoping on resource uri)
        - ordering
   -->
  <select id="dataReportPropValueFrequencyExtraPropEntry"
            parameterClass="java.util.Map" resultMap="dataReportValueFrequency">

    <isNotNull property="limit">
      <!--  Needed for Oracle, renders to empty block by default. -->
      <include refid="dataReportingLimitPrepend"/>
    </isNotNull>
    SELECT e.value, count(e.value) AS frequency 
    FROM extra_prop_entry e
    <isNotNull property="uriWildcard">
      INNER JOIN vortex_resource r ON e.resource_id = r.resource_id
    </isNotNull>
    WHERE
        <isNotNull property="uriWildcard" close="AND">
          r.uri LIKE #uriWildcard# ESCAPE '@'
        </isNotNull>
        <!--  Is this necessary ? -->
        <isNull property="namespace">
          e.name_space IS NULL
        </isNull>
        <isNotNull property="namespace">
          e.name_space = #namespace#
        </isNotNull>
        AND
        e.name = #name#
        GROUP BY e.value
        <isNotEqual property="ordering" compareValue="NONE" prepend="ORDER BY">
          <isEqual property="ordering" compareValue="FREQ_ASC">frequency ASC</isEqual>
          <isEqual property="ordering" compareValue="FREQ_DESC">frequency DESC</isEqual>
          <isEqual property="ordering" compareValue="VALUE_ASC">e.value ASC</isEqual>
          <isEqual property="ordering" compareValue="VALUE_DESC">e.value DESC</isEqual>
        </isNotEqual>
        <isNotNull property="limit" >
           <include refid="dataReportingLimitAppend"/>
        </isNotNull>
  </select>

</sqlMap>
<?xml version="1.0" encoding="utf-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd">


  <!-- List of cluster aware components. The list is populated during
       application context initialization. -->
  <bean id="cluster.components" class="java.util.ArrayList" />

  <bean id="cluster.component" class="org.springframework.beans.factory.config.MethodInvokingBean"
        abstract="true">
    <property name="targetObject" ref="cluster.components" />
    <property name="targetMethod" value="add" />
  </bean>

  <bean parent="cluster.component">
    <property name="arguments">
      <bean class="vtk.cluster.AsyncClusterAware">
        <constructor-arg ref="systemIndex"/>
      </bean>
    </property>
  </bean>

  <bean parent="cluster.component">
    <property name="arguments">
      <bean class="vtk.cluster.AsyncClusterAware">
        <constructor-arg ref="authorizationManager"/>
      </bean>
    </property>
  </bean>

  <bean parent="cluster.component">
    <property name="arguments">
      <bean class="vtk.cluster.AsyncClusterAware">
        <constructor-arg ref="repository.lockingCacheControlWrapper"/>
      </bean>
    </property>
  </bean>

  <!-- Default no-op cluster manager bean. -->  
  <bean id="cluster.manager" class="vtk.cluster.DefaultClusterManager">
    <constructor-arg>
      <ref bean="cluster.components"/>
    </constructor-arg>
  </bean>


  <!-- 
       Cluster Status service:
       
       GET ${cluster.statusURL}/master => if (master) 200 OK else 404 Not Found

       GET ${cluster.statusURL}/node => if (draining) 404 Not Found else 200 OK

  -->

  <bean id="cluster.statusService" class="vtk.web.service.ServiceImpl">
    <property name="order" value="-96000" />
    <property name="assertions">
      <bean class="vtk.web.service.RequestURIRegexpAssertion">
        <property name="pattern" value="${cluster.statusURL}" />
      </bean>
    </property>
    <property name="handler" ref="cluster.statusController" />
  </bean>

  <bean id="cluster.statusController" class="vtk.web.ClusterStatus" />
  
  <bean parent="cluster.component">
    <property name="arguments" ref="cluster.statusController" />
  </bean>

</beans>

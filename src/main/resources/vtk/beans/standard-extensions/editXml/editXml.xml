<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd">

<!-- XML Edit services -->

  <bean id="editService" class="vtk.web.service.ServiceImpl">
    <property name="parent" ref="manageService" />
    <property name="order" value="-9800" />
    <property name="attributes">
      <map>
        <entry key="disable-csrf-checking"><value type="java.lang.Boolean">true</value></entry>
        <entry key="tabOrder"><value type="java.lang.Integer">150</value></entry>
        <entry key="localeResolver" value-ref="manageLocaleResolver" />
        <entry key-ref="system.decoratorTemplateAttribute" value="admin.html" />
      </map>
    </property>
    <property name="assertions">
      <list>
        <bean class="vtk.web.service.RequestParameterAssertion">
          <property name="parameterName" value="mode" />
          <property name="parameterValue" value="edit" />
        </bean>
        <ref bean="resourceTypeIsManagedXml" />
        <ref bean="requiresWritePermissionAssertion" />
        <ref bean="editXslStylesheetAvailable" />
      </list>
    </property>
    <property name="handler" ref="xmlEditHandler" />
  </bean>

  <bean parent="manage.tabsBuilder">
    <property name="arguments" ref="editService" />
  </bean>

  <bean id="editXslStylesheetAvailable" class="vtk.web.service.RepositoryAssertionWrapper">
    <constructor-arg name="assertion">
      <bean class="vtk.repository.resourcetype.XmlSchemaXPathAssertion">
        <constructor-arg name="schemaRegistry" ref="schemaRegistry" />
        <constructor-arg name="schemaPropertyDefinition" ref="schemaPropDef" />
        <constructor-arg name="xpath" value="${editXslTransformationSchemaXPath}" />
      </bean>
    </constructor-arg>
  </bean>


  <!-- XML edit handler -->

  <bean id="xmlEditHandler" class="vtk.edit.xml.XmlEditController"
        parent="repositoryAware">
    <property name="transformerManager" ref="editTransformerManager" />
    <property name="schemaPropDef" ref="schemaPropDef" />

    <property name="viewName" value="xmlEditView" />
    <property name="finishViewName" value="redirectToManage" />

  </bean>
  
  <bean id="editMessageProvider"
        class="vtk.web.referencedata.provider.ResourceMessageProvider">
    <property name="modelName" value="tabMessage" />
    <property name="localizationKey" value="xmledit.tabMessage" />
  </bean>

  <bean id="editTabHelpURLProvider"
        class="vtk.web.referencedata.provider.StaticURLProvider">
    <property name="modelName" value="tabHelpURL" />
    <property name="descriptionKey" value="xmledit.tabHelpURLDescription" />
    <property name="url" value="${editHelpURL}" />
    <property name="target" value="helpWindow" />
  </bean>


  <!-- XML edit view -->

  <bean id="xmlEditView" class="vtk.web.view.xslt.ResourceXsltView">
    <property name="staticAttributes" ref="xslTransformerParameterMap" />
    <property name="referenceDataProviders">
      <list>
        <ref bean="rawXmlQueryURLProvider" />
        <ref bean="editMessageProvider" />
        <ref bean="editTabHelpURLProvider" />
        <bean class="vtk.web.referencedata.provider.StaticModelDataProvider">
          <property name="modelDataMap">
            <map>
              <entry key="serviceCssURLs" value-ref="editCSSURLs" />
            </map>
          </property>
        </bean>
      </list>
    </property>
    <property name="transformerManager" ref="editTransformerManager" />
  </bean>

  <bean id="editCSSURLs" class="java.util.ArrayList">
    <constructor-arg>
      <list>
        <value>${themeBaseURL}/editor-xml.css</value>
      </list>
    </constructor-arg>
  </bean> 
  
  <bean parent="messageSource.addBasenames">
    <property name="arguments" value="vtk.i18n.xmledit" />
  </bean>

  <bean id="editXslStylesheetResolvers" class="java.util.ArrayList">
    <constructor-arg>
      <list>
        <bean class="vtk.xml.StylesheetInSchemaResolver">
          <property name="schemaRegistry" ref="schemaRegistry"/>
          <property name="elementXPath" value="${editXslTransformationSchemaXPath}" />
         </bean>
      </list>
    </constructor-arg>
  </bean>


  <bean id="editTransformerManager" class="vtk.xml.TransformerManager">
    <property name="alwaysCompile" value="true" />
    <property name="stylesheetReferenceResolvers" ref="editXslStylesheetResolvers" />
    <property name="compilationURIResolvers" value="#{{${xsltCompilationURIResolvers}}}" />
     <!--property name="compilationURIResolvers" ref="standardXslCompilationResolvers" /-->
     <property name="transformationURIResolvers">
       <list>
         <ref bean="xsltTransformationRepositoryURIResolver" />
       </list>
     </property>
     <property name="transformationThrottle" ref="xmlTransformationThrottle" />
   </bean>



  <!-- XML edit error handler -->

  <bean id="xmlEditErrorHandler" class="vtk.web.DefaultErrorHandler"
        parent="abstractReferencedataProvidingErrorHandler">
    <description>
      Provides error handling for the XML edit service.
    </description>
    <property name="service" ref="editService" />
    <property name="errorType">
      <bean class="java.lang.Class" factory-method="forName">
        <constructor-arg value="vtk.edit.xml.XMLEditException" />
      </bean>
    </property>
    <property name="errorViewName" value="xmlEditError" />
    <property name="viewResolver" ref="xmlEditErrorViewResolver" />
  </bean>
  <bean parent="vtk.errorHandlers.builder">
    <property name="arguments" ref="xmlEditErrorHandler" />
  </bean>

  <bean id="xmlEditErrorViewResolver" class="vtk.web.decorating.MappingViewResolver">
    <constructor-arg name="views">
      <map>
        <entry key="xmlEditError" value-ref="xmlEditErrorView" />
      </map>
    </constructor-arg>
  </bean>
  

  <bean id="xmlEditErrorView" parent="freemarkerView">
        <property name="url" value="pages/error/edit-xml-error.ftl" />
  </bean>

</beans>

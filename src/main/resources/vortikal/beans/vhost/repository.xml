<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
       http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.0.xsd
       http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.0.xsd">

  
  <!-- Transaction setup -->

  <bean id="repository.transactionManager"
        class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
    <property name="dataSource" ref="repository.dataSource"/>
  </bean>


  <tx:advice id="repository.txAdvice" transaction-manager="repository.transactionManager">
    <tx:attributes>
      <!--tx:method name="get*" read-only="true" /-->
      <tx:method name="*" no-rollback-for="org.vortikal.repository.RepositoryException,org.vortikal.security.AuthenticationException" />
      <!--tx:method name="*" /-->
    </tx:attributes>
  </tx:advice>

  <aop:config>
    <aop:pointcut id="repository.repositoryOperationPointcut" expression="execution(* org.vortikal.repository.Repository.*(..))"/>
    <aop:advisor advice-ref="repository.txAdvice" pointcut-ref="repository.repositoryOperationPointcut"/>
  </aop:config>


  <!-- XXX: identify (indexing-related) pointcuts that should be wrapped in transactions: -->
  <!-- Shouldn't need transaction wrapping here, since IndexDao is already being wrapped -->
<!--  <aop:config>
    <aop:pointcut id="repository.resourceChangeNotifierPointcut" expression="execution(* org.vortikal.repository.index.observation.ResourceChangePoller.pollChanges(..))"/>
    <aop:advisor advice-ref="repository.txAdvice" pointcut-ref="repository.resourceChangeNotifierPointcut"/>
  </aop:config>-->

  <!-- Query result authorization already wrapped by pointcut for SqlMapIndexDao -->
  <!--
  <aop:config>  
    <aop:pointcut id="repository.searchAuthorizationPointcut" expression="execution(* org.vortikal.repository.search.query.security.QueryResultAuthorizationManager.authorizeQueryResults(..))"/>
    <aop:advisor advice-ref="repository.txAdvice" pointcut-ref="repository.searchAuthorizationPointcut"/>
  </aop:config> -->

  <aop:config>
    <aop:pointcut id="repository.sqlMapIndexDaoPointcut" expression="execution(* org.vortikal.repository.store.db.SqlMapIndexDao.*(..))"/>
    <aop:advisor advice-ref="repository.txAdvice" pointcut-ref="repository.sqlMapIndexDaoPointcut"/>
  </aop:config>

  <!-- Repository -->

  <bean id="repository" class="org.vortikal.repository.RepositoryImpl"
        init-method="init" destroy-method="destroy">
    <property name="id" value="${repositoryID}" />
    <property name="tokenManager" ref="tokenManager" />
    <property name="roleManager" ref="roleManager" />
    <property name="authorizationManager" ref="authorizationManager" />
    <property name="dao" ref="repository.cache" />
    <property name="commentDAO" ref="${repository.commentDao}" />
    <property name="contentStore" ref="${repository.contentStore}" />
    <property name="lockManager" ref="repository.lockManager" />
    <property name="repositoryResourceHelper" ref="repositoryResourceHelper" />
    <property name="tempDir" value="${repository.tempDir}" />
  </bean>


  <bean id="repository.dataSource" class="org.apache.commons.dbcp.BasicDataSource"
        destroy-method="close">
    <property name="driverClassName" value="${databaseDriver}" />
    <property name="maxActive" value="${maxDatabaseConnections}" />
    <property name="url" value="${databaseURL}" />
    <property name="username" value="${jdbcUsername}" />
    <property name="password"  value="${jdbcPassword}" />
    <property name="defaultAutoCommit" value="false" />
  </bean>

  

  <!-- SqlMap setup for iBATIS Database Layer -->

  <bean id="repository.sqlMapClient"
        class="org.springframework.orm.ibatis.SqlMapClientFactoryBean">
    <property name="useTransactionAwareDataSource" value="true" />
    <property name="configLocation"
              value="classpath:/org/vortikal/repository/store/db/ibatis/${sqlDialect}-sql-map-config.xml"/>
    <property name="dataSource" ref="repository.dataSource"/>
  </bean>

  <!-- Override iBATIS SQL map statement names in this map (should
       generally not be necessary): -->
  <bean id="repository.statementMappings" class="java.util.HashMap">
    <constructor-arg>
      <map>
      </map>
    </constructor-arg>
  </bean>

  <bean id="repository.sqlMapDao" class="org.vortikal.repository.store.db.SqlMapDataAccessor">
    <lookup-method name="createResourceImpl" bean="resourceImpl"/>
    <property name="sqlMapClient" ref="repository.sqlMapClient"/>
    <property name="sqlMaps" ref="repository.statementMappings" />
    <property name="optimizedAclCopySupported" value="${optimizedAclCopySupported}" />
  </bean>
  
  <bean id="repository.fsContentStore" 
        class="org.vortikal.repository.store.fs.SimpleFileSystemContentStore">
    <property name="urlEncodeFileNames" value="${urlEncodeFileNames}" />
    <property name="repositoryDataDirectory" value="${repositoryDataDirectory}" />
  </bean>

  <bean id="repository.indexDao" class="org.vortikal.repository.store.db.SqlMapIndexDao">
    <property name="sqlMapClient" ref="repository.sqlMapClient"/>
    <property name="sqlMaps" ref="repository.statementMappings" />
    <property name="resourceTypeTree" ref="resourceTypeTree"/>
    
    <!-- How many query hits to process for authorization in one batch -->
    <property name="queryAuthorizationBatchSize" value="1000"/>
    
    <!-- Logger id and logger type for change log -->
    <property name="loggerId" value="1"/>
    <property name="loggerType" value="3"/>
  </bean>

  <bean id="resourceImpl" class="org.vortikal.repository.ResourceImpl" scope="prototype">
    <property name="resourceTypeTree" ref="resourceTypeTree"/>
    <property name="authorizationManager" ref="authorizationManager" />
  </bean>

  <bean id="repository.cache" class="org.vortikal.repository.store.Cache">
    <property name="maxItems" value="${resourceCacheSize}" />
    <property name="wrappedAccessor" ref="${repository.dao}" />
  </bean>

  <bean id="repository.sqlMapCommentDao"
        class="org.vortikal.repository.store.db.SqlMapCommentDAO">
    <property name="sqlMapClient" ref="repository.sqlMapClient"/>
    <property name="sqlMaps" ref="repository.statementMappings" />
  </bean>

  <!--
  <bean id="repository.cache" class="org.vortikal.repository.store.JBossCacheDataAccessor">
    <property name="wrappedAccessor" ref="${repository.dao}" />
    <property name="treeCache" ref="jbossTreeCache" />
  </bean>

  <bean id="jbossTreeCache" class="org.jboss.cache.TreeCache"
        init-method="startService" destroy-method="stopService">
  </bean>
  -->

  <bean id="repository.requestLocal" class="org.vortikal.web.RequestLocalRepository">
    <property name="repository" ref="repository"/>
  </bean>

  <bean id="requestLocalRepositoryAware" abstract="true">
    <description>
      Simple parent template for repository aware controllers.  Just
      saves a couple of lines for each controller having a repository
      property, that's just about all of them
    </description>
    <property name="repository" ref="repository.requestLocal" />
  </bean>

  <bean id="repository.lockManager" class="org.vortikal.repository.LockManager">
    <property name="dao" ref="${repository.dao}" />
  </bean>

  <bean id="repositoryResourceHelper"
        class="org.vortikal.repository.RepositoryResourceHelperImpl">
    <property name="authorizationManager" ref="authorizationManager" />
    <property name="resourceTypeTree" ref="resourceTypeTree" />
    <property name="contentStore" ref="${repository.contentStore}"/>
    <property name="contentRepresentationRegistry" ref="contentRepresentationRegistry"/>
  </bean>
  
  <bean id="resourceTypeTree"
        class="org.vortikal.repository.ResourceTypeTreeImpl" >
    <property name="typeLocalizationProvider" ref="typeLocalizationProvider"/>
  </bean>    

  <bean id="typeLocalizationProvider" 
    class="org.vortikal.repository.resourcetype.MessageSourceTypeLocalizationProvider">
    <property name="messageSource">
      <bean class="org.springframework.context.support.ResourceBundleMessageSource">
        <property name="basename" value="vortikal.i18n.resource-types"/>
      </bean>
    </property>
  </bean>

  <bean id="contentRepresentationRegistry"
        class="org.vortikal.repository.content.ContentRepresentationRegistry" />

  <bean id="jdomContentFactory" class="org.vortikal.repository.content.JDOMContentFactory" />


  <bean id="jtidyContentFactory" class="org.vortikal.repository.content.JTidyContentFactory" />
  <bean id="bufferedImageContentFactory" class="org.vortikal.repository.content.BufferedImageContentFactory" />
  <bean id="audioFileContentFactory"
        class="org.vortikal.repository.content.AudioFileContentFactory" />


  <bean id="authorizationManager" class="org.vortikal.repository.AuthorizationManagerImpl">
    <property name="readOnly" value="${repositoryReadOnly}" />
    <property name="principalManager" ref="principalManager" />
    <property name="lockManager" ref="repository.lockManager" />
    <property name="roleManager" ref="roleManager" />
    <property name="dao" ref="${repository.dao}" />
  </bean>

   <bean id="messageSource"
         class="org.vortikal.web.context.ChildDelegatingMessageSource">
   </bean>

   <bean id="defaultMessageSource"
         class="org.springframework.context.support.ResourceBundleMessageSource">
     <property name="basenames">
       <list>
         <value>vortikal.i18n.messages</value>
       </list>
     </property>
   </bean>

<!--
  <bean id="repository.importer" class="org.vortikal.repository.DataImportUtil">
    <property name="repository" ref="repository" />
  </bean>


  <bean id="repository.evaluator" class="org.vortikal.repository.EvaluatorUtil">
    <property name="resourceTypeTree" ref="resourceTypeTree" />
    <property name="dataAccessor" ref="${repository.dao}" />
  </bean>
-->

<!--   <bean class="org.vortikal.repository.ResourceImpl" scope="prototype"> -->
<!--     <property name="resourceTypeTree" ref="resourceTypeTree" /> -->
<!--     <property name="authorizationManager" ref="authorizationManager" /> -->
<!--   </bean> -->


</beans>

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">

<beans>

  <bean id="queryParser"
        class="org.vortikal.repositoryimpl.query.parser.QueryParser">
    <constructor-arg ref="resourceTypeTree" />
  </bean>

  <bean id="queryManager" class="org.vortikal.repositoryimpl.query.parser.QueryManager">
    <property name="parser" ref="queryParser" />
    <property name="searcher" ref="systemIndexSearcher" />
    <property name="queryStringProcessor" ref="queryStringProcessor" />
  </bean>

  <bean id="queryStringProcessor"
        class="org.vortikal.repositoryimpl.query.parser.QueryStringProcessor">
    <property name="expressionEvaluators">
      <list>
        <bean class="org.vortikal.repositoryimpl.query.parser.CurrentDepthExpressionEvaluator" />
        <bean class="org.vortikal.repositoryimpl.query.parser.CurrentFolderExpressionEvaluator"
              parent="requestLocalRepositoryAware">
          <!-- Temp. name change, remove when ready for changing existing queries-->
          <property name="variableName" value="currentURI" />
        </bean>
        <bean class="org.vortikal.repositoryimpl.query.parser.CurrentTimeExpressionEvaluator">
          <!-- Temp. name change, remove when ready for changing existing queries-->
          <property name="variableName" value="currentDate" />
        </bean>
      </list>
    </property>
  </bean>

  <!-- Document mapper -->
  <bean id="documentMapper" class="org.vortikal.repositoryimpl.query.DocumentMapper">
    <property name="propertyManager" ref="propertyManager"/>
    <property name="valueFactory" ref="valueFactory"/>
  </bean>

  <!-- A Lucene index accessor instance. Manages low-level access. -->
  <bean id="systemIndexAccessor" class="org.vortikal.repositoryimpl.query.LuceneIndex">
    <property name="storageRootPath" value="${indexStorageRootPath}"/>
    <property name="storageId" value="property_index"/>
    <property name="forceUnlock" value="true"/>
    <property name="maxLockAcquireTimeOnShutdown" value="30"/>
  </bean>

  <!-- Property set index based on a single Lucene index accessor instance.  -->
  <bean id="systemIndex" class="org.vortikal.repositoryimpl.query.PropertySetIndexImpl">
    <property name="indexAccessor" ref="systemIndexAccessor"/>
    <property name="documentMapper" ref="documentMapper"/>
    <property name="propertyManager" ref="propertyManager"/>
  </bean>

  <!-- Secondary property set index instance (tuned for batch indexing) -->
  <bean id="secondarySystemIndex" class="org.vortikal.repositoryimpl.query.PropertySetIndexImpl">
    <property name="indexAccessor">
      <!-- This accessor is anonymous, it doesn't need to be referenced from any other beans -->
      <bean class="org.vortikal.repositoryimpl.query.LuceneIndex">
        <property name="storageRootPath" value="${indexStorageRootPath}"/>
        <property name="storageId" value="property_index.secondary"/>
        <property name="maxBufferedDocs" value="100"/>
        <property name="mergeFactor" value="100"/>
        <property name="maxMergeDocs" value="15000"/>
        <property name="forceUnlock" value="true"/>
        <property name="maxLockAcquireTimeOnShutdown" value="30"/>
      </bean>
    </property>
    <property name="documentMapper" ref="documentMapper"/>
    <property name="propertyManager" ref="propertyManager"/>
  </bean>
  
  <!-- Factory for building Lucene queries. -->
  <bean id="queryBuilderFactory"
        class="org.vortikal.repositoryimpl.query.QueryBuilderFactoryImpl">
    <property name="propertyManager" ref="propertyManager"/>
    <property name="indexAccessor" ref="systemIndexAccessor"/>
  </bean>

  <!-- Searcher implementation -->
  <bean id="systemIndexSearcher"
        class="org.vortikal.repositoryimpl.query.SearcherImpl">
    <property name="indexAccessor" ref="systemIndexAccessor"/>
    <property name="documentMapper" ref="documentMapper"/>
    <property name="queryBuilderFactory" ref="queryBuilderFactory"/>
    <property name="maxAllowedHitsPerQuery" value="50000"/>
    <property name="queryResultAuthorizationManager" ref="queryResultAuthorizationManager"/>
  </bean>

  <!-- Query result authorization (ACL checking) -->
  <bean id="queryResultAuthorizationManager"
        class="org.vortikal.repositoryimpl.query.security.DatabaseQueryResultAuthorizationManager">
    <property name="principalManager" ref="principalManager"/>
    <property name="tokenManager" ref="tokenManager"/>
    <property name="indexDataAccessor" ref="repository.indexDataAccessor"/>

    <!-- A set of principals can be excluded from database 
         result authorization check. -->
    <!--property name="noAuthorizationCheckForPrincipals">
      <set>
        <value>root@localhost</value>
      </set>
    </property-->
  </bean>

  <!-- Perform incremental updates on property set index from resource changes. -->
  <bean id="systemIndexUpdater" 
        class="org.vortikal.repositoryimpl.query.observation.PropertySetIndexUpdater">
    <property name="index" ref="systemIndex"/>
    <property name="notifier" ref="repository.resourceChangeNotifier"/>
    <property name="indexDataAccessor" ref="repository.indexDataAccessor"/>
  </bean>
  
</beans>

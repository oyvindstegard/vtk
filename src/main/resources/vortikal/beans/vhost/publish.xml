<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">
<beans>

  <bean id="publish.publishResourceService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="manageService" />
    <property name="assertions">
      <list>
        <ref bean="writeACLPermissionAssertion" />
        <ref bean="structuredResources.typeAssertion" />
        <ref bean="resourceIsNotPublishedAssertion" />
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="publish" />
        </bean>
      </list>
    </property>
    <property name="handler" ref="publishResourceHandler" />
    <property name="categories">
      <set>
        <value>globalMenu</value>
      </set>
    </property>
    <property name="attributes">
      <map>
        <entry key="globalMenuOrder">
          <value type="java.lang.Integer">300</value>
        </entry>
      </map>
    </property>
  </bean>

  <bean id="publish.unpublishResourceService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="manageService" />
    <property name="assertions">
      <list>
        <ref bean="writeACLPermissionAssertion" />
        <ref bean="structuredResources.typeAssertion" />
        <ref bean="resourceIsPublishedAssertion" />
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="unpublish" />
        </bean>
      </list>
    </property>
    <property name="handler" ref="publishResourceHandler" />
    <property name="categories">
      <set>
        <value>globalMenu</value>
      </set>
    </property>
    <property name="attributes">
      <map>
        <entry key="globalMenuOrder">
          <value type="java.lang.Integer">300</value>
        </entry>
      </map>
    </property>
  </bean>

  <bean id="publishResourceHandler" class="org.vortikal.web.actions.publish.PublishResourceController"
    parent="requestLocalRepositoryAware">
    <property name="viewName" value="redirectToManage" />
    <property name="publishDatePropDef" ref="publishDatePropDef" />
  </bean>

  <bean id="resourceIsNotPublishedAssertion" class="org.vortikal.web.service.ResourcePropertyAssertion">
    <property name="namespace" ref="DEFAULT_NAMESPACE" />
    <property name="name" value="published" />
    <property name="value" value="false" />
  </bean>

  <bean id="resourceIsPublishedAssertion" class="org.vortikal.web.service.ResourcePropertyAssertion">
    <property name="namespace" ref="DEFAULT_NAMESPACE" />
    <property name="name" value="published" />
    <property name="value" value="true" />
  </bean>

  <bean id="displayUnpublishedpPageService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="structuredResources.displayService" />
    <property name="order" value="0" />
    <property name="assertions">
      <list>
        <ref bean="resourceIsNotPublishedAssertion" />
      </list>
    </property>
    <property name="handler" ref="displayUnpublishedpPageHandler" />
  </bean>

  <bean id="displayUnpublishedpPageHandler" class="org.vortikal.web.display.file.DisplayResourceController"
    parent="requestLocalRepositoryAware">
    <property name="viewName" value="displayUnpublishedPage.view" />
  </bean>

  <bean id="displayUnpublishedPage.viewResolver" parent="decoratorViewResolver">
    <property name="views">
      <map>
        <entry key="displayUnpublishedPage.view" value-ref="displayUnpublishedPage.view" />
      </map>
    </property>
  </bean>

  <bean id="displayUnpublishedPage.view" parent="freemarkerView">
    <property name="url" value="pages/unpublished-view.ftl" />
  </bean>
  
  <!-- ### view of unpublished resources ### -->
  <bean id="viewUnpublishedResourceService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="structuredResources.displayService" />
    <property name="order" value="-1" />
    <property name="assertions">
      <list>
        <ref bean="viewUnpublishedResourceAssertion" />
      </list>
    </property>
  </bean>

  <bean id="viewUnpublishedAssertion" class="org.vortikal.web.service.RequestParameterAssertion">
    <property name="parameterName" value="view" />
    <property name="parameterValue" value="unpublished" />
  </bean>

  <bean id="viewUnpublishedResourceAssertion" class="org.vortikal.web.service.AndAssertion">
    <property name="assertions">
      <list>
        <ref bean="viewUnpublishedAssertion" />
        <ref bean="requiresWritePermissionAssertion" />        
        <ref bean="resourceIsNotPublishedAssertion" />
      </list>
    </property>
  </bean>

  <bean id="publish.editPublishingService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="manageService" />
    <property name="categories">
      <set>
        <value>tabMenu</value>
      </set>
    </property>
    <property name="attributes">
      <map>
        <entry key="tabOrder"><value type="java.lang.Integer">200</value></entry>
      </map>
    </property>
    <property name="assertions">
      <list>
        <ref bean="writeACLPermissionAssertion" />
        <ref bean="structuredResources.typeAssertion" />
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="mode" />
          <property name="parameterValue" value="publishing" />
        </bean>
      </list>
    </property>
    <property name="handler" ref="publishingHandler" />
  </bean>

  <bean id="publishingHandler" 
    class="org.vortikal.web.display.file.ResourceAwareParameterizableViewController"
    parent="requestLocalRepositoryAware">
    <property name="viewName" value="publishing" />
  </bean>

  <bean id="publishingView" parent="freemarkerView">
    <property name="url" value="pages/publishing.ftl" />
    <property name="referenceDataProviders">
      <ref bean="resourceContextProvider" />
    </property>
  </bean>

</beans>
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">
<beans>

  <bean id="publish.publishResourceService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="manageService" />
    <property name="assertions">
      <list>
        <ref bean="writePermissionAssertion" />
        <ref bean="structuredResources.typeAssertion" />
        <ref bean="resourceIsNotPublishedAssertion" />
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="publish" />
        </bean>
      </list>
    </property>
    <property name="handler" ref="confirmPublishResourceHandler" />
    <property name="categories">
      <set>
        <value>globalMenu</value>
      </set>
    </property>
    <property name="attributes">
      <map>
        <entry key="globalMenuOrder">
          <value type="java.lang.Integer">300</value>
        </entry>
        <entry key="decorating.servicePredicateName" value="publish" />
        <entry key-ref="system.decoratorTemplateAttribute" value="dialog-template.html" />
      </map>
    </property>
  </bean>

  <bean id="publish.unpublishResourceService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="manageService" />
    <property name="assertions">
      <list>
        <ref bean="writePermissionAssertion" />
        <ref bean="structuredResources.typeAssertion" />
        <ref bean="resourceIsPublishedAssertion" />
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="unpublish" />
        </bean>
      </list>
    </property>
    <property name="handler" ref="confirmUnpublishResourceHandler" />
    <property name="categories">
      <set>
        <value>globalMenu</value>
      </set>
    </property>
    <property name="attributes">
      <map>
        <entry key="globalMenuOrder">
          <value type="java.lang.Integer">300</value>
        </entry>
        <entry key="decorating.servicePredicateName" value="publish" />
        <entry key-ref="system.decoratorTemplateAttribute" value="dialog-template.html" />
      </map>
    </property>
  </bean>

  <bean id="confirmPublishResourceHandler" class="org.vortikal.web.actions.publish.ConfirmPublishController"
    parent="repositoryAware">
    <property name="viewName" value="publish.confirm" />
    <property name="publishService" ref="publish.publishResourceConfirmedService" />
  </bean>

  <bean id="confirmUnpublishResourceHandler" class="org.vortikal.web.actions.publish.ConfirmPublishController"
    parent="repositoryAware">
    <property name="viewName" value="publish.confirm" />
    <property name="publishService" ref="publish.unpublishResourceConfirmedService" />
  </bean>

  <bean id="publish.viewResolver" parent="system.decoratingViewResolver">
    <property name="views">
      <map>
        <entry key="publish.confirm" value-ref="publish.confirmView" />
      </map>
    </property>
  </bean>

  <bean id="publish.confirmView" parent="freemarkerView">
    <property name="url" value="pages/confirm-publish.ftl" />
    <property name="referenceDataProviders">
      <list>
        <ref bean="resourceContextProvider" />
      </list>
    </property>
  </bean>

  <bean id="publish.unpublishResourceConfirmedService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="manageService" />
    <property name="order" value="490" />
    <property name="assertions">
      <list>
        <ref bean="manage.postRequestAssertion" />
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="unpublish-confirmed" />
        </bean>
      </list>
    </property>
    <property name="handler" ref="publishResourceHandler" />
  </bean>

  <bean id="publish.publishResourceConfirmedService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="manageService" />
    <property name="order" value="490" />
    <property name="assertions">
      <list>
        <ref bean="manage.postRequestAssertion" />
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="publish-confirmed" />
        </bean>
      </list>
    </property>
    <property name="handler" ref="publishResourceHandler" />
  </bean>

  <bean id="publishResourceHandler" class="org.vortikal.web.actions.publish.PublishResourceController"
    parent="repositoryAware">
    <property name="viewName" value="redirectToManage" />
    <property name="publishDatePropDef" ref="publishDatePropDef" />
  </bean>

  <bean id="resourceIsNotPublishedAssertion" class="org.vortikal.web.service.ResourcePropertyAssertion">
    <property name="namespace" ref="DEFAULT_NAMESPACE" />
    <property name="name" value="published" />
    <property name="value" value="false" />
  </bean>

  <bean id="resourceIsPublishedAssertion" class="org.vortikal.web.service.ResourcePropertyAssertion">
    <property name="namespace" ref="DEFAULT_NAMESPACE" />
    <property name="name" value="published" />
    <property name="value" value="true" />
  </bean>

  <bean id="displayUnpublishedpPageService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="structuredResources.displayService" />
    <property name="order" value="0" />
    <property name="assertions">
      <list>
        <ref bean="resourceIsNotPublishedAssertion" />
      </list>
    </property>
    <property name="handler" ref="displayUnpublishedpPageHandler" />
    <property name="attributes">
      <map>
        <entry key="decorating.servicePredicateName" value="view-unpublished" />
      </map>
    </property>
  </bean>

  <bean id="displayUnpublishedpPageHandler" class="org.vortikal.web.display.file.DisplayResourceController"
    parent="repositoryAware">
    <property name="viewName" value="displayUnpublishedPage.view" />
  </bean>

  <bean id="displayUnpublishedPage.viewResolver" parent="decoratorViewResolver">
    <property name="views">
      <map>
        <entry key="displayUnpublishedPage.view" value-ref="displayUnpublishedPage.view" />
      </map>
    </property>
  </bean>

  <bean id="displayUnpublishedPage.view" parent="freemarkerView">
    <property name="url" value="pages/unpublished-view.ftl" />
    <property name="referenceDataProviders">
      <ref bean="resourceContextProvider" />
    </property>
  </bean>

  <!-- ### view of unpublished resources ### -->
  <bean id="viewUnpublishedResourceService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="structuredResources.displayService" />
    <property name="order" value="-1" />
    <property name="assertions">
      <list>
        <ref bean="viewUnpublishedResourceAssertion" />
      </list>
    </property>
  </bean>

  <bean id="viewUnpublishedAssertion" class="org.vortikal.web.service.RequestParameterAssertion">
    <property name="parameterName" value="view" />
    <property name="parameterValue" value="unpublished" />
  </bean>

  <bean id="viewUnpublishedResourceAssertion" class="org.vortikal.web.service.AndAssertion">
    <property name="assertions">
      <list>
        <ref bean="viewUnpublishedAssertion" />
        <ref bean="requiresWritePermissionAssertion" />
        <ref bean="resourceIsNotPublishedAssertion" />
      </list>
    </property>
  </bean>

  <bean id="publish.editPublishingService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="manageService" />
    <property name="categories">
      <set>
        <value>tabMenu</value>
      </set>
    </property>
    <property name="attributes">
      <map>
        <entry key="tabOrder">
          <value type="java.lang.Integer">200</value>
        </entry>
      </map>
    </property>
    <property name="assertions">
      <list>
        <ref bean="writePermissionAssertion" />
        <ref bean="structuredResources.typeAssertion" />
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="mode" />
          <property name="parameterValue" value="publishing" />
        </bean>
      </list>
    </property>
    <property name="handler" ref="publishingHandler" />
  </bean>

  <bean id="publishingHandler" class="org.vortikal.web.display.file.ResourceAwareParameterizableViewController"
    parent="repositoryAware">
    <property name="viewName" value="publishing" />
  </bean>

  <bean id="editPublishDateService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="publish.editPublishingService" />
    <property name="assertions">
      <list>
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="edit-publish-date" />
        </bean>
      </list>
    </property>
    <property name="handler" ref="editPublishDateHandler" />
  </bean>

  <bean id="editUnpublishDateService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="publish.editPublishingService" />
    <property name="assertions">
      <list>
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="edit-unpublish-date" />
        </bean>
      </list>
    </property>
    <property name="handler" ref="editUnpublishDateHandler" />
  </bean>

  <bean id="abstractEditPublishingHandler" abstract="true" class="org.vortikal.web.actions.publish.EditPublishingController"
    parent="repositoryAware">
    <property name="formView" value="publishing" />
    <property name="successView" value="publishing" />
    <property name="commandClass" value="org.vortikal.web.actions.publish.EditPublishingCommand" />
    <property name="validator">
      <bean class="org.vortikal.web.actions.publish.EditPublishingCommandValidator" >
        <property name="publishDatePropDef" ref="publishDatePropDef" />
        <property name="unpublishDatePropDef" ref="unpublishDatePropDef" />
      </bean>
    </property>
    <property name="publishDatePropDef" ref="publishDatePropDef" />
    <property name="unpublishDatePropDef" ref="unpublishDatePropDef" />
  </bean>

  <bean id="editPublishDateHandler" parent="abstractEditPublishingHandler">
    <property name="commandName" value="publish-date" />
  </bean>

  <bean id="editUnpublishDateHandler" parent="abstractEditPublishingHandler">
    <property name="commandName" value="unpublish-date" />
  </bean>

  <bean id="publishingView" parent="freemarkerView">
    <property name="url" value="pages/publishing.ftl" />
    <property name="referenceDataProviders">
      <list>
        <ref bean="resourceContextProvider" />
        <ref bean="editPublishingProvider" />
      </list>
    </property>
    <property name="attributesMap">
      <map>
        <entry key="jsBaseURL" value="${jsBaseURL}" />
        <entry key="webResources" value="${webResources.baseURL}" />
        <entry key="cssURLs">
          <list>
            <value>${themeBaseURL}/publishing.css</value>
          </list>
        </entry>
      </map>
    </property>
  </bean>

  <bean id="editPublishingProvider" class="org.vortikal.web.referencedata.provider.EditPublishingProvider"
    parent="repositoryAware">
    <property name="publishResourceService" ref="publish.publishResourceService" />
    <property name="unpublishResourceService" ref="publish.unpublishResourceService" />
    <property name="editPublishDateService" ref="editPublishDateService" />
    <property name="editUnpublishDateService" ref="editUnpublishDateService" />
    <property name="publishedPropDef" ref="publishedPropDef" />
  </bean>

</beans>

<?xml version="1.0" encoding="utf-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd">

  <bean id="messageListing.viewService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="collectionListing.viewService" />
    <property name="order" value="0" />
    <property name="assertions">
      <list>
        <ref bean="resourceIsMessageListing" />
      </list>
    </property>
    <property name="handler" ref="messageListing.handler" />
    <property name="serviceNameProvider" ref="collectionListing.viewService.serviceNameProvider" />
  </bean>

  <bean id="messageListing.handler" parent="collectionListing.handler">
    <property name="helper" ref="messageListing.helper" />
    <property name="searchComponents">
      <list>
        <ref bean="messageListing.localRepoLookupSearchComponent" />
      </list>
    </property>
  </bean>

  <!-- ## Default search component for message listing ## -->
  <bean id="messageListing.searchComponent" parent="collectionListing.searchComponent">
    <property name="name" value="messageListing.defaultListing" />
    <property name="queryBuilders">
      <list>
        <bean parent="queryStringParser">
          <property name="queryString" value="type IN structured-message" />
        </bean>
      </list>
    </property>
    <property name="searchSorting" ref="messageListing.searchSorting" />
    <property name="configurablePropertySelectPointers">
      <list>
        <value>title</value>
        <value>publish-date</value>
        <value>resource:isTruncated</value>
        <value>resource:listingDisplayedMessage</value>
        <value>lastModified</value>
        <value>contentLocale</value>
        <value>numberOfComments</value>
      </list>
    </property>
  </bean>

  <!-- ##
    Hack message listing search component to work around delay in
    index update on create/delete/update operations on messages.
    Will do extra lookup in local repo for changes depending on
    action performed (resolved by checking request parameters).
  ## -->
  <bean id="messageListing.localRepoLookupSearchComponent"
    class="org.vortikal.web.search.messagelisting.MessageListingLocalRepositoryLookupSearchComponent"
    parent="messageListing.searchComponent">
    <property name="name" value="messageListing.localRepoLookupSearchComponent" />
  </bean>

  <bean id="messageListing.helper" class="org.vortikal.web.decorating.components.CollectionListingHelper">
    <property name="applicableResourceTypes">
      <set>
        <value>structured-message</value>
      </set>
    </property>
    <property name="documentPrincipalMetadataRetriever" ref="documentPrincipalMetadataRetriever" />
  </bean>

  <bean id="messageListing.feedService" parent="collectionListing.atomService">
    <property name="order" value="-2" />
    <property name="assertions">
      <list>
        <ref bean="resourceIsMessageListing" />
        <ref bean="feedParameterSetAssertion" />
      </list>
    </property>
    <property name="handler" ref="messageListing.feedHandler" />
  </bean>

  <bean id="messageListing.feedHandler" class="org.vortikal.web.display.collection.message.MessageListingAsAtomFeed"
    parent="viewAsFeedHandler">
    <property name="searchComponent" ref="messageListing.searchComponent" />
  </bean>

  <bean id="messageListing.searchSorting" class="org.vortikal.web.search.SearchSorting" depends-on="resourceTypeTree">
    <property name="sortOrderPropDefPointers">
      <list>
        <value>publish-date</value>
      </list>
    </property>
    <property name="resourceTypeTree" ref="resourceTypeTree" />
    <property name="defaultSortOrder" ref="SORT_ORDER.DESC" />
  </bean>

</beans>

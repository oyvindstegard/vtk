<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">
<beans>

  <bean id="decoratingViewWrapper"
        class="org.vortikal.web.view.decorating.DecoratingViewWrapper">
    <property name="decorators">
      <list>
        <ref bean="decorating.templateDecorator" />
      </list>
    </property>
    <property name="staticHeaders">
      <map>
        <entry key="Cache-Control" value="no-cache, no-store, must-revalidate, max-age=0" />
        <entry key="Pragma" value="no-cache" />
      </map>
    </property>
  </bean>

  <bean id="decorating.templateDecorator"
        class="org.vortikal.web.view.decorating.TemplateDecorator">
    <property name="htmlParser" ref="decorating.htmlParser" />
    <property name="decorationResolver" ref="decorating.decorationResolver" />
    <property name="htmlNodeFilters" ref="decorating.nodeFilters" />
    <property name="tidyXhtml" value="${decorating.tidyXhtml}" />
  </bean>

  <bean id="decorating.nodeFilters"
        class="org.springframework.beans.factory.config.ListFactoryBean">
    <property name="sourceList">
      <list>
        <!--ref bean="decorating.nodeLabelFilter" /-->
        <ref bean="decorating.ssiNodeFilter" />
      </list>
    </property>
  </bean>


  <bean id="decorating.htmlParser"
        class="org.vortikal.text.htmlparser.HtmlPageParserImpl">
    <property name="compositeTags" ref="decorating.htmlParser.compositeTags" />
    <property name="emptyTags" ref="decorating.htmlParser.emptyTags" />
  </bean>

  <bean id="decorating.htmlParser.compositeTags"
        class="org.springframework.beans.factory.config.SetFactoryBean">
    <property name="sourceSet">
      <set>
        <value>pre</value>
        <value>b</value>
        <value>address</value>
        <value>map</value>
        <value>thead</value>
        <value>tfoot</value>
        <value>tbody</value>
        <value>fieldset</value>
        <value>optgroup</value>
        <value>small</value>
        <value>big</value>
        <value>i</value>
        <value>tt</value>
        <value>em</value>
        <value>acronym</value>
        <value>strong</value>
        <value>code</value>
        <value>samp</value>
        <value>kbd</value>
        <value>var</value>
      </set>
    </property>
  </bean>

  <bean id="decorating.htmlParser.emptyTags"
        class="org.springframework.beans.factory.config.SetFactoryBean">
    <property name="sourceSet">
      <set>
        <value>br</value>
        <value>area</value>
        <value>link</value>
        <value>img</value>
        <value>param</value>
        <value>hr</value>
        <value>input</value>
        <value>col</value>
        <value>base</value>
        <value>meta</value>
      </set>
    </property>
  </bean>


  <!--
  <bean id="decorating.nodeLabelFilter"
        class="org.vortikal.web.view.decorating.NodeLabellingFilter">
    <property name="labelElements">
      <set>
        <value>h2</value>
        <value>h3</value>
        <value>h4</value>
        <value>h5</value>
        <value>h6</value>
        <value>h7</value>
        <value>h8</value>
      </set>
    </property>
  </bean>
  -->

  <bean id="decorating.ssiNodeFilter" class="org.vortikal.web.view.decorating.ComponentHandlingNodeFilter">
    <property name="ssiDirectiveComponentMap">
      <map>
        <entry key="include" value-ref="decorating.includeComponent" />
      </map>
    </property>
    <property name="prohibitedComponentNamespaces">
      <set>
        <ref bean="decorating.documentNamespace" />
      </set>
    </property>
    <property name="contentComponentParser" ref="decorating.defaultTemplateParser" />
    <property name="parseAttributes" value="true" />
  </bean>

  <bean id="decorating.decorationResolver"
        class="org.vortikal.web.view.decorating.ConfigurableDecorationResolver"
        parent="requestLocalRepositoryAware">
    <property name="templateManager" ref="decorating.templateManager" />
    <property name="decorationConfiguration" ref="decorating.configurationPropertiesFile" />
    <property name="parseableContentPropDef" ref="containsSSIDirectivesPropDef" />
  </bean>

  <bean id="decorating.configurationPropertiesFile"
        class="org.vortikal.util.repository.PropertiesResource">
    <property name="repository" ref="repository" />
    <property name="uri" value="${decorating.templateConfigFile}" />
    <property name="lazyInit" value="false" />
  </bean>

  <bean id="decorating.templateConfigRefreshTrigger"
        class="org.vortikal.util.repository.MethodInvokingRepositoryEventTrigger">
    <property name="repository" ref="repository" />
    <property name="uri" value="${decorating.templateConfigFile}" />
    <property name="targetObject" ref="decorating.configurationPropertiesFile" />
    <property name="method" value="load" />
  </bean>


  <bean id="decorating.templateManager" class="org.vortikal.web.view.decorating.CollectionTemplateManager">
    <property name="repository" ref="repository" />
    <property name="collectionName" value="${decorating.templatesCollection}" />
    <property name="templateParser" ref="decorating.defaultTemplateParser" />
    <property name="templateResourceType" ref="htmlResourceTypeDefinition" />
  </bean>

  <bean id="decorating.templateCollectionRefreshTrigger"
        class="org.vortikal.util.repository.MethodInvokingRepositoryEventTrigger">
    <property name="repository" ref="repository" />
    <property name="uri" value="${decorating.templatesCollection}" />
    <property name="targetObject" ref="decorating.templateManager" />
    <property name="method" value="load" />
  </bean>


  <bean id="decorating.defaultTemplateParser" class="org.vortikal.web.view.decorating.DefaultTemplateParser">
    <property name="componentResolver" ref="decorating.defaultComponentResolver" />
  </bean>

  <bean name="decorating.defaultComponentResolver"
        class="org.vortikal.web.view.decorating.BeanContextComponentResolver" />

  <bean name="decorating.documentComponentResolver"
        class="org.vortikal.web.view.decorating.BeanContextComponentResolver">
    <property name="prohibitedComponentNamespaces">
      <set>
        <ref bean="decorating.documentNamespace" />
      </set>
    </property>
  </bean>


  <bean id="listDecoratorComponentsService" class="org.vortikal.web.service.ServiceImpl">
    <property name="order" value="-200" />
    <property name="categories">
      <set>
        <value>plaintextEditTooltipService</value>
      </set>
    </property>
    <property name="assertions">
      <list>
        <ref bean="webServiceAssertion" />
        <bean class="org.vortikal.web.service.ResourceTypeAssertion">
          <property name="resourceTypeDefinition" ref="htmlResourceTypeDefinition" />
        </bean>
        <bean class="org.vortikal.web.service.ResourceURIRegexpAssertion">
          <property name="pattern" value="^${decorating.templatesCollection}/.*" />
        </bean>
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="list-decorator-components" />
        </bean>
      </list>
    </property>
    <property name="handler">
      <ref bean="listDecoratorComponentsHandler" />
    </property>
    <property name="authenticationChallenge">
      <ref bean="${webAuthenticationChallenge}" />
    </property>
  </bean>

  <bean id="listDocumentsComponentsService" class="org.vortikal.web.service.ServiceImpl">
    <property name="order" value="-200" />
    <property name="categories">
      <set>
        <value>plaintextEditTooltipService</value>
      </set>
    </property>
    <property name="assertions">
      <list>
        <ref bean="webServiceAssertion" />
        <bean class="org.vortikal.web.service.ResourceTypeAssertion">
          <property name="resourceTypeDefinition" ref="htmlResourceTypeDefinition" />
        </bean>
        <bean class="org.vortikal.web.service.ResourceURIRegexpAssertion">
          <property name="pattern" value="^${decorating.templatesCollection}/.*" />
          <property name="invert" value="true" />
        </bean>
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="list-decorator-components" />
        </bean>
      </list>
    </property>
    <property name="handler">
      <ref bean="listDocumentComponentsHandler" />
    </property>
  </bean>

  <bean name="listDecoratorComponentsHandler" class="org.vortikal.web.controller.MethodInvokingController">
    <property name="targetObject" ref="decorating.defaultComponentResolver" />
    <property name="targetMethod" value="listComponents" />
    <property name="modelName" value="componentList" />
    <property name="viewName" value="listDecoratorComponents" />
  </bean>

  <bean name="listDocumentComponentsHandler" class="org.vortikal.web.controller.MethodInvokingController">
    <property name="targetObject" ref="decorating.documentComponentResolver" />
    <property name="targetMethod" value="listComponents" />
    <property name="modelName" value="componentList" />
    <property name="viewName" value="listDecoratorComponents" />
  </bean>
  
  <bean id="listDecoratorComponentsViewResolver"
        class="org.vortikal.web.view.decorating.MappingViewResolver">
    <property name="views">
      <map>
        <entry key="listDecoratorComponents" value-ref="listDecoratorComponentsView" />        
      </map>
    </property>
  </bean>

  <bean id="listDecoratorComponentsView" parent="freemarkerView">
    <property name="url" value="pages/list-decorator-components.ftl" />
    <property name="referenceDataProviders">
      <list>
      </list>
    </property>
  </bean>

</beans>

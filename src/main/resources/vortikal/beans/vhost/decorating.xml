<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">

<beans>

  
  <bean id="decorating.manageLinkProvider"
        class="org.vortikal.web.referencedata.provider.ResourceServiceURLProvider"
        parent="requestLocalRepositoryAware">
    <property name="modelName" value="manage" />
    <property name="urlName" value="manageURL" />
    <property name="service" ref="manageService" />
  </bean>

  <bean id="decoratingViewWrapper"
        class="org.vortikal.web.view.decorating.DecoratingViewWrapper">
    <property name="templateResolver" ref="templateResolver" />
    <property name="referenceDataProviders">
      <list>
        <ref bean="decorating.manageLinkProvider" />
      </list>
    </property>
    <property name="ssiHandler" ref="ssiHandler"  />
  </bean>

  <bean id="ssiHandler"
        class="org.vortikal.web.view.decorating.ssi.SsiHandler">
    <property name="ssiProcessors">
      <set>
        <bean class="org.vortikal.web.view.decorating.ssi.HttpSsiProcessor" />
        <bean class="org.vortikal.web.view.decorating.ssi.RepositoryAccessingSsiProcessor"
              parent="requestLocalRepositoryAware" />
        <bean class="org.vortikal.web.view.decorating.ssi.RepositoryAccessingSsiProcessor"
              parent="requestLocalRepositoryAware">
          <property name="identifier" value="virtual" />
        </bean>
        <bean class="org.vortikal.web.view.decorating.ssi.RssRenderingSsiProcessor">
          <property name="view" ref="feedView" />
        </bean>
      </set>
    </property>
  </bean>

  <bean id="feedView" parent="freemarkerView">
    <property name="url" value="layouts/renderedFeed.ftl" />
  </bean>

  <bean id="templateResolver"
        class="org.vortikal.web.view.decorating.PropertyConfigurableTemplateResolver">
    <property name="templateManager" ref="templateManager" />
    <property name="templateConfiguration" ref="templateConfigurationPropertiesFile" />
  </bean>

  <bean id="templateConfigurationPropertiesFile"
        class="org.vortikal.util.repository.PropertiesResource">
    <property name="repository" ref="repository" />
    <property name="uri" value="${decorating.templateConfigFile}" />
    <property name="lazyInit" value="false" />
  </bean>

  <bean id="templateConfigRefreshTrigger"
        class="org.vortikal.util.repository.MethodInvokingRepositoryEventTrigger">
    <property name="repository" ref="repository" />
    <property name="uri" value="${decorating.templateConfigFile}" />
    <property name="targetObject" ref="templateConfigurationPropertiesFile" />
    <property name="method" value="load" />
  </bean>


  <bean id="templateManager" class="org.vortikal.web.view.decorating.CollectionTemplateManager">
    <property name="repository" ref="repository" />
    <property name="collectionName" value="${decorating.templatesCollection}" />
    <property name="templateParser" ref="defaultTemplateParser" />
  </bean>

  <bean id="templateCollectionRefreshTrigger"
        class="org.vortikal.util.repository.MethodInvokingRepositoryEventTrigger">
    <property name="repository" ref="repository" />
    <property name="uri" value="${decorating.templatesCollection}" />
    <property name="targetObject" ref="templateManager" />
    <property name="method" value="load" />
  </bean>


  <bean id="defaultTemplateParser" class="org.vortikal.web.view.decorating.DefaultTemplateParser">
    <property name="componentResolver" ref="defaultComponentResolver" />
  </bean>

  <bean name="defaultComponentResolver" class="org.vortikal.web.view.decorating.BeanContextComponentResolver">
    
  </bean>


  <bean id="listDecoratorComponentsService" class="org.vortikal.web.service.ServiceImpl">
    <!--property name="parent" ref="webService" /-->
    <property name="order" value="-200" />
    <property name="categories">
      <set>
        <value>plaintextEditTooltipService</value>
      </set>
    </property>
    <property name="assertions">
      <list>
        <ref bean="webServiceAssertion" />
        <bean class="org.vortikal.web.service.ResourceURIRegexpAssertion">
          <property name="pattern" value="^${decorating.templatesCollection}/.*" />
        </bean>
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="list-decorator-components" />
        </bean>
      </list>
    </property>
    <property name="handler">
      <ref bean="listDecoratorComponentsHandler" />
    </property>
  </bean>

  <bean name="listDecoratorComponentsHandler" class="org.vortikal.web.controller.MethodInvokingController">
    <property name="targetObject" ref="defaultComponentResolver" />
    <property name="targetMethod" value="listComponents" />
    <property name="modelName" value="componentList" />
    <property name="viewName" value="listDecoratorComponents" />
  </bean>

  
  <bean id="listDecoratorComponentsViewResolver"
        class="org.vortikal.web.view.wrapper.MappingViewResolver">
    <property name="views">
      <map>
        <entry key="listDecoratorComponents" value-ref="listDecoratorComponentsView" />        
      </map>
    </property>
  </bean>


  <bean id="listDecoratorComponentsView" parent="freemarkerView">
    <property name="url" value="pages/list-decorator-components.ftl" />
    <property name="referenceDataProviders">
      <list>
      </list>
    </property>
  </bean>


</beans>

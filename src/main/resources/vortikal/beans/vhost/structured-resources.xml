<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">
<beans>
  
  <bean id="structuredResources.typeAssertion" class="org.vortikal.web.service.ResourceTypeAssertion"
        parent="repositoryAware">
    <property name="resourceTypeDefinition" ref="json.managedObjectResourceType" />
  </bean>

  <bean id="structuredResources.displayService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="displayResourceService" />
    <property name="assertions">
      <list>
        <ref bean="structuredResources.typeAssertion" />
      </list>
    </property>
    <property name="handler" ref="structuredResources.displayHandler" />
  </bean>
  
  <bean id="structuredResources.previewService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="previewService" />
    <property name="assertions">
      <list>
        <ref bean="structuredResources.typeAssertion" />
      </list>
    </property>
    <property name="handler" ref="previewAdminIframeHandler" />
  </bean>
  
  <bean id="mayPreviewUnpublishedResourceAssertion" class="org.vortikal.web.service.AndAssertion">
    <property name="assertions">
      <list>
        <ref bean="requiresWritePermissionAssertion" />        
        <ref bean="resourceIsNotPublishedAssertion" />
      </list>
    </property>
  </bean>
  
 
  <bean id="structuredResources.editService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="manageService" />
    <property name="order" value="-9800" />
    <property name="assertions">
      <list>
        <ref bean="structuredResources.typeAssertion" />
        <ref bean="requiresWritePermissionAssertion" />
        <ref bean="editor.modeParameterAssertion" />
        <ref bean="editor.parameterEqualsEdit" />
      </list>
    </property>
    <property name="categories">
      <set>
        <value>tabMenu</value>
      </set>
    </property>
    <property name="attributes">
      <map>
        <entry key="tabOrder">
          <value type="java.lang.Integer">152</value>
        </entry>
      </map>
    </property>
    <property name="handler" ref="structuredResources.editHandler" />
  </bean>


  
  <bean id="structuredResources.displayHandler"
        class="org.vortikal.resourcemanagement.view.StructuredResourceDisplayController"
    parent="repositoryAware"
    depends-on="structuredResource.parser">
    <property name="viewName" value="structuredResources.displayView" />
    <property name="resourceManager" ref="structuredResources.resourceManager" />
    <property name="htmlParser" ref="decorating.htmlParser" />
    <property name="templateManager" ref="structuredResources.templateManager" />
    <property name="resourceModelKey" value="structured-resource" />
    <property name="postFilter" ref="decorating.ssiNodeFilter" />
    <property name="directiveHandlers" ref="structuredResources.directives" />
    <property name="configProviders">
      <list>
        <bean class="org.vortikal.web.referencedata.provider.FixedResourceServiceURLProvider">
          <property name="repository" ref="repository" />
          <property name="uri" value="/" />
          <property name="appendPath" value="${flash.baseURL}/audioplayer.swf" />
          <property name="service" ref="viewService" />
          <property name="modelName" value="flashPlayer" />
          <property name="urlName" value="flashURL" />
        </bean>
        <bean class="org.vortikal.web.referencedata.provider.FixedResourceServiceURLProvider">
          <property name="repository" ref="repository" />
          <property name="uri" value="/" />
          <property name="appendPath" value="${jsBaseURL}/audio-player.js" />
          <property name="service" ref="viewService" />
          <property name="modelName" value="flashPlayer" />
          <property name="urlName" value="jsURL" />
        </bean>
      </list>
    </property>
  </bean>

  <bean id="structuredResources.templateManager" class="org.vortikal.resourcemanagement.view.DecoratorTemplateManager">
    <property name="templateFactory" ref="structuredResources.decoratorTemplateFactory" />
    <property name="resourceManager" ref="structuredResources.resourceManager" />
  </bean>
  
  <bean id="structuredResources.decoratorTemplateFactory"
            class="org.vortikal.web.decorating.SimpleDynamicDecoratorTemplateFactory">
    <property name="directiveHandlers" ref="structuredResources.directives" />
    <property name="componentResolver" ref="decorating.defaultComponentResolver" />
    <property name="htmlParser" ref="decorating.htmlParser" />
  </bean>

  <bean id="structuredResources.directives"
        class="org.springframework.beans.factory.config.MapFactoryBean">
    <property name="sourceMap">
      <map>
        <entry key="if" value-ref="structuredResources.ifDirective" />
        <entry key="val" value-ref="structuredResources.valDirective" />
        <entry key="list" value-ref="structuredResources.listDirective" />
        <entry key="def" value-ref="structuredResources.defDirective" />
        <entry key="resource-props" value-ref="structuredResources.resourcePropsDirective" />
        <entry key="localized" value-ref="structuredResources.localizedDirective" />
        <entry key="call" value-ref="structuredResources.callDirective" />
      </map>
    </property>
  </bean>

  <bean id="structuredResources.ifDirective" class="org.vortikal.text.tl.IfNodeFactory" />

  <bean id="structuredResources.valDirective" class="org.vortikal.text.tl.ValNodeFactory">
    <constructor-arg>
      <map>
        <entry>
          <key><value type="java.lang.Class">org.vortikal.repository.PropertyImpl</value></key>
          <bean class="org.vortikal.resourcemanagement.view.tl.PropertyValueFormatHandler">
            <constructor-arg>
              <ref bean="valueFormatterRegistry" />
            </constructor-arg>
          </bean>
        </entry>
        <entry>
          <key><value type="java.lang.Class">org.vortikal.repository.resourcetype.Value</value></key>
          <bean class="org.vortikal.resourcemanagement.view.tl.PropertyValueFormatHandler">
            <constructor-arg ref="valueFormatterRegistry" />
          </bean>
        </entry>
        <entry>
          <key>
            <value type="java.lang.Class">org.vortikal.repository.resourcetype.Value[]</value>
          </key>
          <bean class="org.vortikal.resourcemanagement.view.tl.PropertyValueFormatHandler">
            <constructor-arg ref="valueFormatterRegistry" />
          </bean>
        </entry>
      </map>
    </constructor-arg>
  </bean>

  <bean id="structuredResources.listDirective" class="org.vortikal.text.tl.ListNodeFactory">
    <property name="functions" ref="structuredResources.defaultFunctions" />
  </bean>

  <bean id="structuredResources.defDirective" class="org.vortikal.text.tl.DefineNodeFactory">
    <property name="functions" ref="structuredResources.defaultFunctions" />
  </bean>

  <bean id="structuredResources.resourcePropsDirective" class="org.vortikal.resourcemanagement.view.tl.ResourcePropsNodeFactory">
    <constructor-arg ref="repository" />
  </bean>

  <bean id="structuredResources.localizedDirective" class="org.vortikal.resourcemanagement.view.tl.LocalizationNodeFactory">
    <constructor-arg value="structured-resource" />
  </bean>

  <bean id="structuredResources.callDirective" class="org.vortikal.resourcemanagement.view.tl.ComponentInvokerNodeFactory">
    <constructor-arg>
      <bean class="org.vortikal.resourcemanagement.view.StructuredResourceDisplayController$ComponentSupport" />
    </constructor-arg>
  </bean>

  <bean id="structuredResources.defaultFunctions"
        class="org.springframework.beans.factory.config.SetFactoryBean">
    <property name="sourceSet">
      <set>
        <ref bean="templateLanguage.concatFunction" />
        <ref bean="templateLanguage.splitFunction" />
        <ref bean="structuredResources.resourceFunction" />
        <ref bean="structuredResources.resourcePropFunction" />
        <ref bean="structuredResources.resourcePropObjValFunction" />
        <ref bean="structuredResources.structuredDocumentFunction" />
        <ref bean="structuredResources.jsonAttrFunction" />
        <ref bean="structuredResources.searchFunction" />
        <ref bean="structuredResources.viewURLFunction" />
        <ref bean="structuredResources.toDateFunction" />
      </set>
    </property>
  </bean>

  <bean id="structuredResources.resourceFunction" class="org.vortikal.resourcemanagement.view.tl.RetrieveHandler">
    <constructor-arg>
      <bean class="org.vortikal.text.tl.Symbol">
        <constructor-arg value="resource" />
      </bean>
    </constructor-arg>
    <constructor-arg ref="repository" />
  </bean>

  <bean id="structuredResources.resourcePropFunction" class="org.vortikal.resourcemanagement.view.tl.ResourcePropHandler">
    <constructor-arg>
      <bean class="org.vortikal.text.tl.Symbol">
        <constructor-arg value="resource-prop" />
      </bean>
    </constructor-arg>
    <constructor-arg ref="repository" />
  </bean>

  <bean id="structuredResources.resourcePropObjValFunction" class="org.vortikal.resourcemanagement.view.tl.ResourcePropObjectValueHandler">
    <constructor-arg>
      <bean class="org.vortikal.text.tl.Symbol">
        <constructor-arg value="resource-prop-obj-val" />
      </bean>
    </constructor-arg>
    <constructor-arg ref="repository" />
  </bean>

  <bean id="structuredResources.structuredDocumentFunction" class="org.vortikal.resourcemanagement.view.tl.JSONDocumentProvider">
    <constructor-arg>
      <bean class="org.vortikal.text.tl.Symbol">
        <constructor-arg value="structured-document" />
      </bean>
    </constructor-arg>
  </bean>

  <bean id="structuredResources.jsonAttrFunction" class="org.vortikal.resourcemanagement.view.tl.JSONAttributeHandler">
    <constructor-arg>
      <bean class="org.vortikal.text.tl.Symbol">
        <constructor-arg value="json-attr" />
      </bean>
    </constructor-arg>
  </bean>

  <bean id="structuredResources.searchFunction" class="org.vortikal.resourcemanagement.view.tl.SearchResultValueProvider">
    <constructor-arg>
      <bean class="org.vortikal.text.tl.Symbol">
        <constructor-arg value="search" />
      </bean>
    </constructor-arg>
    <constructor-arg ref="queryParserFactory" />
    <constructor-arg ref="systemIndexSearcher" />
  </bean>

  <bean id="structuredResources.viewURLFunction" class="org.vortikal.resourcemanagement.view.tl.ViewURLValueProvider">
    <constructor-arg>
      <bean class="org.vortikal.text.tl.Symbol">
        <constructor-arg value="view-url" />
      </bean>
    </constructor-arg>
    <constructor-arg ref="viewService" />
  </bean>

  <bean id="structuredResources.toDateFunction" class="org.vortikal.resourcemanagement.view.tl.ToDateFunction">
    <constructor-arg>
      <bean class="org.vortikal.text.tl.Symbol">
        <constructor-arg value="to-date" />
      </bean>
    </constructor-arg>
  </bean>





  <bean id="structuredResources.componentNamespace" class="java.lang.String">
    <constructor-arg type="java.lang.String" value="json" />
  </bean>

  <bean id="structuredResources.fieldSelectComponent"
        class="org.vortikal.resourcemanagement.view.StructuredResourceFieldComponent">
    <property name="namespace" ref="structuredResources.componentNamespace" />
    <property name="name" value="field" />
    <property name="resourceModelKey" value="structured-resource" />
  </bean>

  <bean id="structuredResources.editHandler" class="org.vortikal.resourcemanagement.edit.StructuredResourceEditor">
    <property name="safeHtmlFilter" ref="resourceManager.htmlPropsFilter" />
    <property name="resourceManager" ref="structuredResources.resourceManager" />
    <property name="repository" ref="repository" />
    <property name="formView" value="structuredResources.editView" />
    <property name="successView" value="redirectToManage" />
    <property name="listComponentsService" ref="jsonDocumentsComponentsService" />
  </bean>
  
  <bean id="structuredResources.viewResolver" parent="decoratorViewResolver">
    <property name="views">
      <map>
        <entry key="structuredResources.displayView" value-ref="structuredResources.displayView" />
      </map>
    </property>
  </bean>
  
  <bean id="structuredResources.wrappingViewResolver" parent="adminViewResolver">
    <property name="views">
      <map>
        <entry key="structuredResources.editView" value-ref="structuredResources.editView" />
      </map>
    </property>
  </bean>
  
  <bean id="structuredResources.displayView" class="org.vortikal.web.decorating.TemplateView">
    <property name="templateRef" value="structured-resources.template" />
    <property name="templateManager" ref="article.templateManager" />
  </bean>
  
  <bean id="structuredResources.editView" parent="freemarkerView">
    <property name="url" value="structured-resources/editor.ftl" />
    <property name="referenceDataProviders">
      <list>
        <ref bean="resourceContextProvider" />
        <ref bean="manage.refreshLockURLProvider" />
        <bean class="org.vortikal.web.referencedata.provider.StaticURIServiceURLProvider">
          <property name="service" ref="staticResourceService" />
          <property name="path" value="${editor.fck.resourcesURL}" />
          <property name="modelName" value="fckeditorBase" />
        </bean>
        <bean class="org.vortikal.web.referencedata.provider.StaticURIServiceURLProvider">
          <property name="service" ref="editor.browseService" />
          <property name="path" value="${editor.fck.browseURL}" />
          <property name="modelName" value="fckBrowse" />
        </bean>
        <bean class="org.vortikal.web.referencedata.provider.ResourceServiceURLProvider">
          <property name="repository" ref="repository" />
          <property name="service" ref="viewService" />
          <property name="modelName" value="fckeditorBase" />
          <property name="urlName" value="documentURL" />
          <property name="staticURLProtocol" value="${webProtocolRestricted}" />
        </bean>
        
        <bean class="org.vortikal.web.referencedata.provider.StaticModelDataProvider">
          <property name="modelDataMap">
            <map>
              <entry key="cssURLs" value-ref="structuredResources.editCSSURLs" />
              <entry key="jsBaseURL" value="${jsBaseURL}" />
              <entry key="webResources" value="${webResources.baseURL}" />
              <entry key="themeBaseURL" value="${themeBaseURL}" />
              <entry key="editorHelpURL" value="${editor.helpURL}" />
            </map>
          </property>
        </bean>
      </list>
    </property>
  </bean>
  
  <bean id="structuredResources.editCSSURLs" class="java.util.ArrayList">
    <constructor-arg>
      <list>
        <value>${themeBaseURL}/basic.css</value>
        <value>${themeBaseURL}/tabs.css</value>
        <value>${themeBaseURL}/structured-resources/editor.css</value>
        <value>${webResources.baseURL}/thickbox-modified/thickbox.css</value>
      </list>
    </constructor-arg>
  </bean>
        
  <!-- Head components for CSS and JavaScript -->     
        
  <bean id="person.componentNamespace" class="java.lang.String">
    <constructor-arg type="java.lang.String" value="person" />
  </bean>
  
  <bean id="project.componentNamespace" class="java.lang.String">
    <constructor-arg type="java.lang.String" value="project" />
  </bean>
  
   <bean id="structured-article.componentNamespace" class="java.lang.String">
    <constructor-arg type="java.lang.String" value="structured-article" />
  </bean>
  
   <bean id="frontpage.componentNamespace" class="java.lang.String">
    <constructor-arg type="java.lang.String" value="frontpage" />
  </bean>
  
  <bean id="structured-article.cssComponent"
        class="org.vortikal.web.decorating.components.ViewRenderingDecoratorComponent">
    <property name="namespace" ref="structured-article.componentNamespace" />
    <property name="name" value="css" />
    <property name="description" value="Inserts CSS references for new articles and events" />
    <property name="view" ref="structured-article.cssView" />
  </bean>

  <bean id="structured-article.cssView" parent="freemarkerView">
    <property name="url" value="system/css.ftl" />
    <property name="attributesMap">
      <map>
        <entry key="cssURLs">
          <list>
            <value>${themeBaseURL}/structured-resources/view-structured-article.css</value>
            <value>${themeBaseURL}/structured-resources/view-structured-container.css</value>
            <value>${themeBaseURL}/structured-resources/share.css</value>
          </list>
        </entry>
      </map>
    </property>
  </bean>
  
  <bean id="frontpage.cssComponent"
        class="org.vortikal.web.decorating.components.ViewRenderingDecoratorComponent">
    <property name="namespace" ref="frontpage.componentNamespace" />
    <property name="name" value="css" />
    <property name="description" value="Inserts CSS references for frontpages" />
    <property name="view" ref="frontpage.cssView" />
  </bean>
  
    <bean id="frontpage.cssView" parent="freemarkerView">
    <property name="url" value="system/css.ftl" />
    <property name="attributesMap">
      <map>
        <entry key="cssURLs">
          <list>
            <value>${themeBaseURL}/structured-resources/view-frontpage.css</value>
            <value>${themeBaseURL}/view-container.css</value>
          </list>
        </entry>
      </map>
    </property>
  </bean>
  
    <bean id="person.cssComponent"
        class="org.vortikal.web.decorating.components.ViewRenderingDecoratorComponent">
    <property name="namespace" ref="person.componentNamespace" />
    <property name="name" value="css" />
    <property name="description" value="Inserts CSS references for persons" />
    <property name="view" ref="person.cssView" />
  </bean>

  <bean id="person.cssView" parent="freemarkerView">
    <property name="url" value="system/css.ftl" />
    <property name="attributesMap">
      <map>
        <entry key="cssURLs">
          <list>
            <value>${themeBaseURL}/structured-resources/view-person.css</value>
            <value>${themeBaseURL}/view-container.css</value>
          </list>
        </entry>
      </map>
    </property>
  </bean>
  
  <bean id="person.javascriptComponent"
        class="org.vortikal.web.decorating.components.ViewRenderingDecoratorComponent">
    <property name="namespace" ref="person.componentNamespace" />
    <property name="name" value="javascript" />
    <property name="description" value="Inserts the default person javascript references" />
    <property name="view" ref="person.javascriptView" />
    <property name="exposeMvcModel" value="true" />
  </bean>

  <bean id="person.javascriptView" parent="freemarkerView">
    <property name="url" value="system/javascript.ftl" />
    <property name="attributesMap">
      <map>
        <entry key="jsURLs">
          <list>
            <value>${webResources.baseURL}/js/tabs.js</value>
          </list>
        </entry>
      </map>
    </property>
  </bean>
  
  <bean id="project.cssComponent"
        class="org.vortikal.web.decorating.components.ViewRenderingDecoratorComponent">
    <property name="namespace" ref="project.componentNamespace" />
    <property name="name" value="css" />
    <property name="description" value="Inserts CSS references for projects" />
    <property name="view" ref="project.cssView" />
  </bean>

  <bean id="project.cssView" parent="freemarkerView">
    <property name="url" value="system/css.ftl" />
    <property name="attributesMap">
      <map>
        <entry key="cssURLs">
          <list>
            <value>${themeBaseURL}/structured-resources/view-project.css</value>
            <value>${themeBaseURL}/view-container.css</value>
          </list>
        </entry>
      </map>
    </property>
   </bean>
  
</beans>

<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">
<beans>
  
  <bean id="structuredResources.displayService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="displayResourceService" />
    <property name="assertions">
      <list>
        <ref bean="json.contentTypeAssertion" />
      </list>
    </property>
    <property name="handlerInterceptors">
      <list>
        <ref bean="noCacheViewHandlerInterceptor" />
      </list>
    </property>
    <property name="handler" ref="structuredResources.displayHandler" />
  </bean>
  
  <bean id="structuredResources.previewService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="previewService" />
    <property name="assertions">
      <list>
        <ref bean="json.contentTypeAssertion" />
      </list>
    </property>
    <property name="handler" ref="previewIframeHandler" />
  </bean>


  <bean id="structuredResources.editService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="manageService" />
    <property name="order" value="-9800" />
    <property name="assertions">
      <list>
        <ref bean="editor.modeParameterAssertion" />
        <ref bean="requiresWritePermissionAssertion" />
        <ref bean="editor.parameterEqualsEdit" />
        <ref bean="json.contentTypeAssertion" />
      </list>
    </property>
    <property name="categories">
      <set>
        <value>tabMenu</value>
      </set>
    </property>
    <property name="attributes">
      <map>
        <entry key="tabOrder">
          <value type="java.lang.Integer">152</value>
        </entry>
      </map>
    </property>
    <property name="handler" ref="structuredResources.editHandler" />
  </bean>
  
  <bean id="structuredResources.resourceManager" class="org.vortikal.resourcemanagement.StructuredResourceManager">
    <property name="resourceTypeTree" ref="resourceTypeTree" />
    <property name="baseType" ref="json.managedObjectResourceType" />
    <property name="valueFactory" ref="valueFactory" />
    <property name="valueFormatterRegistry" ref="valueFormatterRegistry" />
    <property name="assertion" ref="json.objectHasResourceTypeAssertion" />
  </bean>

  <bean id="structuredResources.displayHandler"
        class="org.vortikal.resourcemanagement.StructuredResourceDisplayController"
    parent="requestLocalRepositoryAware"
    depends-on="structuredResource.parser">
    <property name="viewName" value="structuredResources.displayView" />
    <property name="resourceManager" ref="structuredResources.resourceManager" />
    <property name="htmlParser" ref="decorating.htmlParser" />
    <property name="templateManager" ref="structuredResources.templateManager" />
    <property name="resourceModelKey" value="structured-resource" />
    <property name="valueFormatterRegistry" ref="valueFormatterRegistry" />
    <property name="configProviders">
      <list>
        <bean class="org.vortikal.web.referencedata.provider.FixedResourceServiceURLProvider">
          <property name="repository" ref="repository" />
          <property name="uri" value="/" />
          <property name="appendPath" value="${flash.baseURL}/audioplayer.swf" />
          <property name="service" ref="viewService" />
          <property name="modelName" value="flashPlayer" />
          <property name="urlName" value="flashURL" />
        </bean>
        <bean class="org.vortikal.web.referencedata.provider.FixedResourceServiceURLProvider">
          <property name="repository" ref="repository" />
          <property name="uri" value="/" />
          <property name="appendPath" value="${jsBaseURL}/audio-player.js" />
          <property name="service" ref="viewService" />
          <property name="modelName" value="flashPlayer" />
          <property name="urlName" value="jsURL" />
        </bean>
      </list>
    </property>
  </bean>

  <bean id="structuredResources.templateManager" class="org.vortikal.resourcemanagement.DecoratorTemplateManager">
    <property name="templateFactory" ref="structuredResources.decoratorTemplateFactory" />
    <property name="resourceManager" ref="structuredResources.resourceManager" />
  </bean>
  
  <bean id="structuredResources.decoratorTemplateFactory"
        class="org.vortikal.web.decorating.ParsedHtmlDecoratorTemplateFactory">
    <property name="htmlParser" ref="decorating.htmlParser" />
    <property name="componentResolver" ref="decorating.defaultComponentResolver" />
    <property name="componentParser" ref="decorating.dollarSyntaxTemplateParser" />
  </bean>


  <bean id="structuredResources.componentNamespace" class="java.lang.String">
    <constructor-arg type="java.lang.String" value="json" />
  </bean>


  <bean id="structuredResources.fieldSelectComponent"
        class="org.vortikal.resourcemanagement.StructuredResourceFieldComponent">
    <property name="namespace" ref="structuredResources.componentNamespace" />
    <property name="name" value="field" />
    <property name="resourceModelKey" value="structured-resource" />
  </bean>

  <bean id="structuredResources.editHandler" class="org.vortikal.resourcemanagement.StructuredResourceEditor">
    <property name="resourceManager" ref="structuredResources.resourceManager" />
    <property name="repository" ref="repository" />
    <property name="formView" value="structuredResources.editView" />
    <property name="successView" value="redirectToManage" />
  </bean>
  
  <bean id="structuredResources.viewResolver" parent="decoratorViewResolver">
    <property name="views">
      <map>
        <entry key="structuredResources.displayView" value-ref="structuredResources.displayView" />
      </map>
    </property>
  </bean>
  
  <bean id="structuredResources.wrappingViewResolver" parent="adminViewResolver">
    <property name="views">
      <map>
        <entry key="structuredResources.editView" value-ref="structuredResources.editView" />
      </map>
    </property>
  </bean>
  
  <bean id="structuredResources.displayView" class="org.vortikal.web.decorating.TemplateView">
    <!--
    <property name="templateManager" ref="structuredResources.templateManager" />
    -->
    <property name="templateRef" value="structured-resources.template" />

    <property name="templateManager" ref="article.templateManager" />
    <!--
    <property name="templateRef" value="article.template" />
    -->
  </bean>
  
  <bean id="structuredResources.editView" parent="freemarkerView">
    <property name="url" value="structured-resources/editor.ftl" />
    <property name="referenceDataProviders">
      <list>
        <ref bean="resourceContextProvider" />
        <bean class="org.vortikal.web.referencedata.provider.FixedResourceServiceURLProvider">
          <property name="repository" ref="repository" />
          <property name="service" ref="staticResourceService" />
          <property name="uri" value="/" />
          <property name="appendPath" value="${editor.fck.resourcesURL}" />
          <property name="modelName" value="fckeditorBase" />
          <property name="urlName" value="url" />
        </bean>
        <bean class="org.vortikal.web.referencedata.provider.StaticURIServiceURLProvider">
          <property name="service" ref="editor.browseService" />
          <property name="path" value="${editor.fck.browseURL}" />
          <property name="modelName" value="fckBrowse" />
        </bean>
                <bean class="org.vortikal.web.referencedata.provider.ResourceServiceURLProvider">
          <property name="repository" ref="repository" />
          <property name="service" ref="viewService" />
          <property name="modelName" value="fckeditorBase" />
          <property name="urlName" value="documentURL" />
        </bean>
        
        <bean class="org.vortikal.web.referencedata.provider.StaticModelDataProvider">
          <property name="modelDataMap">
            <map>
              <entry key="jsBaseURL" value="${jsBaseURL}" />
              <entry key="webResources" value="${webResources.baseURL}" />
              <entry key="themeBaseURL" value="${themeBaseURL}" />
            </map>
          </property>
        </bean>
      </list>
    </property>
  </bean>
  
  <bean id="structuredResource.parser"
        class="org.vortikal.resourcemanagement.parser.StructuredResourceParser">
    <property name="defaultResourceTypeDefinitions"
              value="classpath:/vortikal/beans/vhost/structured-resources.vrtx" />
    <property name="structuredResourceManager"
              ref="structuredResources.resourceManager" />
  </bean>
  
</beans>

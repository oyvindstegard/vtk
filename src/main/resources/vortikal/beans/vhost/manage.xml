<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" 
"http://www.springframework.org/dtd/spring-beans.dtd">

<beans>

  <!-- MANAGE services -->
  
  <!-- (deleteResourceService has been moved out of manageService and
       made a root level service because in some cases delete URLs
       could not be generated since manageService requires read
       permission) -->

  <bean id="deleteResourceService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="webService" />
    <property name="order" value="490" />
    <property name="categories">
      <set>
        <value>resourceMenu</value>
      </set>
    </property>
    <property name="attributes">
      <map>
        <entry key="resourceMenuOrder"><value type="java.lang.Integer">100</value></entry>
      </map>
    </property>
    <property name="assertions">
      <list>
        <ref local="resourceNotRootAssertion" />
        <ref local="adminVrtxParameterRule" />
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="delete" />
        </bean>
        <ref local="deleteResourcePermissionAssertion" />
      </list>
    </property>
    <property name="handlerInterceptors">
      <list>
        <ref bean="noCacheHandlerInterceptor" />
      </list>
    </property>
    <property name="handler" ref="deleteResourceHandler" />
  </bean>

  <bean id="manageService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="webService" />
    <property name="order" value="500" />
    <property name="assertions">
      <list>
        <ref local="adminVrtxParameterRule" />
        <ref bean="requiresReadPermissionAssertion" />
      </list>
    </property>
    <property name="handlerInterceptors">
      <list>
        <ref bean="noCacheHandlerInterceptor" />
      </list>
    </property>
    <property name="attributes">
      <map>
        <entry key="localeResolver" value-ref="manageLocaleResolver" />
        <entry key-ref="system.decoratorTemplateAttribute" value="admin.html" />
      </map>
    </property>
  </bean>

  <bean id="setNorwegianNBLocaleService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="manageService" />
    <property name="assertions">
      <list>
        <ref bean="requestLocaleNotNorwegianNB"/>
        <ref bean="localeParameterEqualsNO" />
      </list>
    </property>
    <property name="handler" ref="setNorwegianNBLocaleController"/>
  </bean>

  <bean id="setNorwegianNNLocaleService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="manageService" />
    <property name="assertions">
      <list>
        <ref bean="requestLocaleNotNorwegianNN"/>
        <ref bean="localeParameterEqualsNN" />
      </list>
    </property>
    <property name="handler" ref="setNorwegianNNLocaleController"/>
  </bean>

  <bean id="setEnglishLocaleService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="manageService" />
    <property name="assertions">
      <list>
        <ref bean="requestLocaleNotEnglish" />
        <ref bean="localeParameterEqualsEN" />
      </list>
    </property>
    <property name="handler" ref="setEnglishLocaleController"/>
  </bean>

  <bean id="permissionsService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="manageService" />
    <property name="categories">
      <set>
        <value>tabMenu</value>
      </set>
    </property>
    <property name="attributes">
      <map>
        <entry key="tabOrder"><value type="java.lang.Integer">200</value></entry>
      </map>
    </property>
    <property name="assertions">
      <bean class="org.vortikal.web.service.RequestParameterAssertion">
        <property name="parameterName" value="mode" />
        <property name="parameterValue" value="permissions" />
      </bean>
    </property>
    <property name="handler" ref="permissionsHandler" />
  </bean>

  <bean id="manage.refreshLockService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="manageService" />
    <property name="assertions">
      <list>
        <ref bean="manage.refreshLockRequestParameter" />
      </list>
    </property>
    <property name="handler">
      <ref bean="manage.refreshLockHandler" />
    </property>
  </bean>

  <bean id="aboutResourceService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="manageService" />
    <property name="categories">
      <set>
        <value>tabMenu</value>
      </set>
    </property>
    <property name="attributes">
      <map>
        <entry key="tabOrder"><value type="java.lang.Integer">300</value></entry>
      </map>
    </property>
    <property name="assertions">
      <list>
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="mode" />
          <property name="parameterValue" value="about" />
        </bean>
      </list>
    </property>
    <property name="handler" ref="aboutResourceHandler" />
  </bean>
  
  <bean id="manageCollectionListingService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="manageService" />
    <property name="order" value="1" />
    <property name="categories">
      <set>
        <value>tabMenu</value>
      </set>
    </property>
    <property name="attributes">
      <map>
        <entry key="tabOrder"><value type="java.lang.Integer">0</value></entry>
      </map>
    </property>
    <property name="assertions">
      <ref bean="resourceInCollection" />
    </property>
    <property name="handler" ref="manageCollectionListingHandler" />
  </bean>  
  
  <bean id="lockResourceService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="manageService" />
    <property name="categories">
      <set>
        <value>lockUnlockAction</value>
      </set>
    </property>
    <property name="assertions">
      <list>
        <ref bean="lockPermissionAssertion" />
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="lock" />
        </bean>
      </list>
    </property>  
    <property name="handler" ref="lockResourceHandler" />
  </bean>

  <bean id="unlockResourceService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="manageService" />
    <property name="categories">
      <set>
        <value>lockUnlockAction</value>
      </set>
    </property>
    <property name="assertions">
      <list>
        <ref bean="unlockPermissionAssertion" />
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="unlock" />
        </bean>
      </list>
    </property>  
    <property name="handler" ref="unlockResourceHandler" />
  </bean>

  <bean id="fileUploadService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="manageCollectionListingService" />
    <property name="order" value="-980" />
    <property name="categories">
      <set>
        <value>collectionMenu</value>
      </set>
    </property>
    <property name="assertions">
      <list>
        <ref bean="bindPermissionAssertion" />
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="upload-file" />
        </bean>
        <ref bean="resourceInCollection" />
      </list>
    </property>
    <property name="handler" ref="fileUploadHandler" />
  </bean>  

  <bean id="createDocumentService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="manageCollectionListingService" />
    <property name="order" value="-970" />
    <property name="categories">
      <set>
        <value>collectionMenu</value>
      </set>
    </property>
    <property name="assertions">
      <list>
        <ref bean="bindPermissionAssertion" />
        <ref bean="resourceInCollection" />
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="create-document" />
        </bean>
      </list>
    </property>  
    <property name="handler" ref="createDocumentHandler" />
  </bean>

  <bean id="createCollectionService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="manageCollectionListingService" />
    <property name="order" value="-960" />
    <property name="categories">
      <set>
        <value>collectionMenu</value>
      </set>
    </property>
    <property name="assertions">
      <list>
        <ref bean="bindPermissionAssertion" />
        <ref bean="resourceInCollection" />
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="create-directory" />
        </bean>
      </list>
    </property>  
    <property name="handler" ref="createCollectionHandler" />
  </bean>

  <bean id="renameService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="aboutResourceService" />
    <property name="order" value="-1000" />
    <property name="categories">
      <set>
        <value>resourceMenu</value>
      </set>
    </property>
    <property name="attributes">
      <map>
        <entry key="resourceMenuOrder"><value type="java.lang.Integer">0</value></entry>
      </map>
    </property>
    <property name="assertions">
      <list>
        <ref local="deleteResourcePermissionAssertion" />
        <ref local="resourceNotRootAssertion" />
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="rename" />
        </bean>
      </list>
    </property>
    <property name="handler" ref="renameHandler" />
  </bean>
  
  <bean id="ownershipService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="aboutResourceService" />
    <property name="assertions">
      <list>
        <ref local="delegateOwnershipPermissionAssertion" />
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="delegate-ownership" />
        </bean>
      </list>
    </property>  
    <property name="handler" ref="ownershipHandler" />
  </bean>

  <bean id="aclInheritanceService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="permissionsService" />
    <property name="assertions">
      <list>
        <ref local="resourceNotRootAssertion" />
        <ref local="writeACLPermissionAssertion" />
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="toggle-acl-inheritance" />
        </bean>
      </list>
    </property>  
    <property name="handler" ref="aclInheritanceHandler" />
  </bean>

  <bean id="editWritePermissionsService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="permissionsService" />
    <property name="assertions">
      <list>
        <ref local="writeACLPermissionAssertion" />
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="edit-write-permissions" />
        </bean>
      </list>
    </property>  
    <property name="handler" ref="editWritePermissionsHandler" />
  </bean>

  <bean id="editReadPermissionsService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="permissionsService" />
    <property name="assertions">
      <list>
        <ref local="writeACLPermissionAssertion" />
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="edit-read-permissions" />
        </bean>
      </list>
    </property>  
    <property name="handler" ref="editReadPermissionsHandler" />
  </bean>

  <bean id="editAdminPermissionsService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="permissionsService" />
    <property name="assertions">
      <list>
        <ref local="writeACLPermissionAssertion" />
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="edit-admin-permissions" />
        </bean>
      </list>
    </property>  
    <property name="handler" ref="editAdminPermissionsHandler" />
  </bean>

  <bean id="editAddCommentPermissionsService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="permissionsService" />
    <property name="assertions">
      <list>
        <ref local="writeACLPermissionAssertion" />
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="edit-commenting-permissions" />
        </bean>
      </list>
    </property>  
    <property name="handler" ref="editAddCommentPermissionsHandler" />
  </bean>

  <bean id="editBindPermissionsService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="permissionsService" />
    <property name="assertions">
      <list>
        <ref local="writeACLPermissionAssertion" />
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="edit-bind-permissions" />
        </bean>
      </list>
    </property>  
    <property name="handler" ref="editBindPermissionsHandler" />
  </bean>

  <bean id="editReadProcessedPermissionsService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="permissionsService" />
    <property name="assertions">
      <list>
        <ref local="writeACLPermissionAssertion" />
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="edit-read-processed-permissions" />
        </bean>
      </list>
    </property>  
    <property name="handler" ref="editReadProcessedPermissionsHandler" />
  </bean>

  <bean id="setContentTypeService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="aboutResourceService" />
    <property name="assertions">
      <list>
        <ref bean="writePermissionAssertion" />
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="edit-content-type" />
        </bean>
      </list>
    </property>  
    <property name="handler" ref="setContentTypeController" />
  </bean>

  <bean id="setContentLanguageService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="aboutResourceService" />
    <property name="assertions">
      <list>
        <ref bean="writePermissionAssertion" />
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="edit-language-type" />
        </bean>
      </list>
    </property>  
    <property name="handler" ref="setContentLanguageController" />
  </bean>

  <bean id="setCharacterEncodingService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="aboutResourceService" />
    <property name="assertions">
      <list>
        <ref bean="writePermissionAssertion" />
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="edit-character-encoding" />
        </bean>
        <ref bean="contentTypeMatchesText" />
      </list>
    </property>  
    <property name="handler" ref="setCharacterEncodingController" />
  </bean>

  <bean id="setResourcePropertyService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="aboutResourceService" />
    <property name="assertions">
      <list>
        <ref bean="writePermissionAssertion" />
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="set-property" />
        </bean>
      </list>    
    </property>
    <property name="handler" ref="setResourcePropertyController" />
  </bean>

  <bean id="deleteResourcePropertyService"
        class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="aboutResourceService" />
    <property name="assertions">
      <list>
        <ref bean="writePermissionAssertion" />
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="delete-property" />
        </bean>
      </list>    
    </property>
    <property name="handler" ref="deleteResourcePropertyController" />
  </bean>
  
  <bean id="transformHtmlToXhtmlService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="manageService" /> 
    <property name="order" value="-997" />
    <property name="categories">
      <set>
        <value>resourceMenu</value>
      </set>
    </property>
    <property name="attributes">
      <map>
        <entry key="resourceMenuOrder"><value type="java.lang.Integer">2000</value></entry>
      </map>
    </property>
    <property name="assertions">
      <list>
        <bean class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="html-to-xhtml" />
        </bean>
        <ref bean="resourceTypeIsHtml" /> 
        <ref bean="resourceTypeIsNotXhtmlTrans" /> 
        <ref bean="bindPermissionAssertion" />
      </list>
    </property>
    <property name="handler" ref="htmlToXhtmlHandler" />
  </bean>
  
  <bean id="resourceTypeIsHtml" class="org.vortikal.web.service.ResourceTypeAssertion">
    <property name="resourceTypeDefinition" ref="htmlResourceTypeDefinition" />
  </bean>

  <bean id="resourceTypeIsNotXhtmlTrans" class="org.vortikal.web.service.ResourceTypeAssertion">
    <property name="resourceTypeDefinition" ref="xhtml10TransResourceTypeDefinition" />
    <property name="invert" value="true" />
  </bean>

  <bean id="htmlToXhtmlHandler" 
        class="org.vortikal.web.controller.repository.copy.CopyController"
        parent="requestLocalRepositoryAware">
    <property name="extension" value="-kopi.html" />
    <property name="parentViewOnSuccess" value="true" />
    <property name="copyAction" ref="tidyCopyAction" />
    <property name="formView" value="admin" />
    <property name="successView" value="redirectToManage" />
    <property name="cancelView" value="redirectToManage" />
    <property name="commandClass" value="org.vortikal.web.controller.repository.copy.CopyCommand" />
    <property name="validator">
      <bean class="org.vortikal.web.controller.repository.copy.CopyCommandValidator"
        parent="requestLocalRepositoryAware" />
    </property>
  </bean>
  
  <bean id="manage.refreshLockHandler"
        class="org.vortikal.web.controller.repository.LockRefreshController"
        parent="requestLocalRepositoryAware">
    <property name="viewName" value="manage.refreshLockView" />
  </bean>

  <bean id="tidyCopyAction" 
        class="org.vortikal.web.controller.repository.copy.SimpleFilteringCopyAction"
        parent="requestLocalRepositoryAware">
    <property name="filter">
      <bean class="org.vortikal.web.controller.repository.tidy.JTidyTransformer">
        <property name="insertedCssReference" value="${tidyConvertInsertedCssRef}" />
      </bean>
    </property>
  </bean>

  <!-- Locale controllers -->

  <bean id="setNorwegianNBLocaleController"
        class="org.vortikal.web.controller.SetLocaleController">
    <property name="locale">
      <bean class="java.util.Locale">
        <constructor-arg value="no" />
      </bean>
    </property>
    <property name="localeResolver" ref="manageLocaleResolver" />
    <property name="viewName" value="redirectToManage" />
  </bean>

  <bean id="setNorwegianNNLocaleController"
        class="org.vortikal.web.controller.SetLocaleController">
    <property name="locale">
      <bean class="java.util.Locale">
        <constructor-arg value="nn" />
      </bean>
    </property>
    <property name="localeResolver" ref="manageLocaleResolver" />
    <property name="viewName" value="redirectToManage"/>
  </bean>

  <bean id="setEnglishLocaleController"
        class="org.vortikal.web.controller.SetLocaleController">
    <property name="locale">
      <bean class="java.util.Locale">
        <constructor-arg value="en" />
      </bean>
    </property>
    <property name="localeResolver" ref="manageLocaleResolver" />
    <property name="viewName" value="redirectToManage" />
  </bean>

  <!-- preview services -->
  
  <bean id="previewService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="manageService" />
    <property name="order" value="1" />
    <property name="categories" value="tabMenu" />
    <property name="attributes">
      <map>
        <entry key="tabOrder"><value type="java.lang.Integer">100</value></entry>
      </map>
    </property>
    <property name="assertions">
      <list>
        <bean class="org.vortikal.web.service.ResourceTypeAssertion">
          <property name="resourceTypeDefinition" ref="collectionResourceTypeDefinition" />
          <property name="invert" value="true" />
        </bean>
        <bean class="org.vortikal.web.service.RequestMethodAssertion">
          <property name="method" value="GET" />
        </bean>
      </list>
    </property>
    <property name="handler" ref="previewFallbackHandler" />
  </bean>

  <bean id="previewHTMLService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="previewService" />
    <property name="assertions">
      <list>
        <ref bean="contentTypeMatchesHtml" />
      </list>
    </property>
    <property name="handler" ref="previewIframeHandler" />
  </bean>

  <bean id="previewImageService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="previewService" />
    <property name="assertions">
      <list>
        <ref bean="contentTypeMatchesImage" />
      </list>
    </property>
    <property name="handler" ref="previewImageHandler" />
  </bean>

  <bean id="previewTextService" class="org.vortikal.web.service.ServiceImpl">
    <property name="order" value="10" />
    <property name="parent" ref="previewService" />
    <property name="assertions">
      <list>
        <ref bean="contentTypeMatchesAnyText" />
      </list>
    </property>
    <property name="handler" ref="previewTextHandler" />
  </bean>

  <bean id="previewCollectionListingService" class="org.vortikal.web.service.ServiceImpl">
    <property name="parent" ref="manageService" />
    <property name="order" value="-1" />
    <property name="categories">
      <set>
        <value>tabMenu</value>
      </set>
    </property>
    <property name="attributes">
      <map>
        <entry key="tabOrder"><value type="java.lang.Integer">100</value></entry>
      </map>
    </property>
    <property name="assertions">
      <list>
        <ref bean="resourceInCollection" />
        <bean id="previewVrtxParameterRule" class="org.vortikal.web.service.RequestParameterAssertion">
          <property name="parameterName" value="action" />
          <property name="parameterValue" value="preview" />
        </bean>
      </list>
    </property>
    <property name="handler" ref="previewIframeHandler" />
    <property name="handlerInterceptors" ref="previewCollectionListingServiceInterceptor" />
  </bean>

  <bean id="previewCollectionListingServiceInterceptor"
        class="org.vortikal.web.ReferenceDataProvidingHandlerInterceptor">
    <property name="providers" ref="indexFileMessageProvider" />
  </bean>

  <bean id="indexFileMessageProvider"
        class="org.vortikal.web.referencedata.provider.IndexFileMessageProvider">
    <property name="modelName" value="tabMessage" />
    <property name="localizationKey" value="preview.folderWithIndexFile.tabMessage" />
  </bean>

  <!-- MANAGE controllers -->

  <bean id="aboutResourceHandler" 
        class="org.vortikal.web.controller.properties.PropertyEditController"
        parent="requestLocalRepositoryAware">
    <property name="propertyTypeDefinitions">
      <list>
        <ref bean="lastModifiedPropDef" />
        <ref bean="modifiedByPropDef" />
        <ref bean="creationTimePropDef" />
        <ref bean="createdByPropDef" />
        <ref bean="ownerPropDef" />
        <!-- resourceType -->
        <!-- webadress -->
        <!-- webDAVadress -->
        <ref bean="contentLocalePropDef" />
        <ref bean="contentLengthPropDef" />

        <ref bean="userTitlePropDef" />
        <ref bean="titlePropDef" />
        <ref bean="hiddenPropDef" />
        <ref bean="importancePropDef" />

        <ref bean="keywordsPropDef" />
        <ref bean="descriptionPropDef" />
        <ref bean="verifiedDatePropDef" />
        <ref bean="authorNamePropDef" />
        <ref bean="authorEmailPropDef" />
        <ref bean="authorURLPropDef" />
        <ref bean="scientificDisciplinesPropDef" />
        
        <ref bean="contentTypePropDef" />
        <ref bean="userSpecifiedCharacterEncodingPropDef" />
        <ref bean="guessedCharacterEncodingPropDef" />
        <ref bean="characterEncodingPropDef" />

        <ref bean="plaintextEditPropDef" />
        <ref bean="xhtml10TransTypePropDef" />

        <!-- Collection type: -->
        <ref bean="collection.typePropDef" />

      </list>
    </property>
    <property name="propertyListModelName" value="basicPropList" />
    <property name="propertyMapModelName" value="aboutItems" />

    <property name="formView" value="admin" />
    <property name="successView" value="redirectToAbout" />

    <property name="commandName" value="form" />
    <property name="dateFormat" value="dd.MM.yyyy HH:mm:ss" />
    <property name="vocabularyChooserService" ref="vocabularyHelpService" />
    <property name="valueFactory" ref="valueFactory"/>
    <property name="validator">
      <bean class="org.vortikal.web.controller.properties.PropertyEditValidator">
        <property name="valueFactory" ref="valueFactory" />
        <property name="principalManager" ref="principalManager" />
      </bean>
    </property>
  </bean>

  <bean id="fileUploadHandler" 
    class="org.vortikal.web.controller.repository.FileUploadController"
    parent="requestLocalRepositoryAware">
    <property name="formView" value="manageCollectionListing" />
    <property name="successView" value="redirectToManage" />
    <property name="commandName" value="uploadForm" />
    <property name="commandClass"
              value="org.vortikal.web.controller.repository.FileUploadCommand" />
    <property name="tempDir" value="${repository.tempDir}" />
  </bean>

  <bean id="deleteResourceHandler" 
    class="org.vortikal.web.controller.repository.DeleteResourceController"
    parent="requestLocalRepositoryAware">
    <property name="viewName" value="redirectToManage" />
  </bean>

  <bean id="lockResourceHandler" 
    class="org.vortikal.web.controller.repository.LockResourceController"
    parent="requestLocalRepositoryAware" />

  <bean id="unlockResourceHandler" 
    class="org.vortikal.web.controller.repository.UnlockResourceController"
    parent="requestLocalRepositoryAware" />

  <bean id="createDocumentHandler" 
    class="org.vortikal.web.controller.repository.TemplateBasedCreateController"
    parent="requestLocalRepositoryAware">
    <property name="formView" value="manageCollectionListing" />
    <property name="successView" value="redirectToManage" />
    <property name="commandName" value="createDocumentForm" />
    <property name="commandClass"
      value="org.vortikal.web.controller.repository.CreateDocumentCommand" />
    <property name="validator">
      <bean class="org.vortikal.web.controller.repository.CreateDocumentCommandValidator"
            parent="requestLocalRepositoryAware" />
    </property>
    <property name="templateManager" ref="templates.resourceTemplateManager" />
  </bean>

  <bean id="defaultDocumentTemplates" 
    class="org.vortikal.web.controller.repository.DefaultDocumentTemplates">
    <property name="templatesCollection"
              value="${documentTemplatesCollection}" />
    <property name="repository" ref="repository" />
    <property name="trustedToken" ref="trustedToken" />
    <property name="parseCategoryTemplates"
              value="${documentTemplatesParseCategoryTemplates}" />
    <property name="parseTopTemplates"
              value="${documentTemplatesParseTopTemplates}" />
  </bean>

  <bean id="documentTemplatesRefreshTrigger"
        class="org.vortikal.util.repository.MethodInvokingRepositoryEventTrigger">
    <property name="repository" ref="repository" />
    <property name="uriPattern" value="${documentTemplatesCollection}/.*" />
    <property name="targetObject" ref="defaultDocumentTemplates" />
    <property name="method" value="refresh" />
  </bean>

  <bean id="createCollectionHandler" 
    class="org.vortikal.web.controller.repository.TemplateBasedCreateCollectionController"
    parent="requestLocalRepositoryAware">
    <property name="formView" value="manageCollectionListing" />
    <property name="successView" value="redirectToManage" />
    <property name="commandName" value="createCollectionForm" />
    <property name="commandClass"
      value="org.vortikal.web.controller.repository.CreateCollectionCommand" />
    <property name="userTitlePropDef" ref="userTitlePropDef" />
    <property name="downcaseCollectionNames" value="true" />
    <property name="templateManager" ref="templates.resourceTemplateManager" />
    <property name="replaceNameChars">
      <map>
        <entry key=" +" value="-" />
        <entry key="æ" value="ae" />
        <entry key="ø" value="oe" />
        <entry key="å" value="aa" />
      </map>
    </property>
  </bean>

  <bean id="renameHandler" 
    class="org.vortikal.web.controller.repository.RenameController"
    parent="requestLocalRepositoryAware">
    <property name="formView" value="admin" />
    <property name="successView" value="redirectToManage" />
    <property name="commandName" value="renameForm" />
    <property name="commandClass"
      value="org.vortikal.web.controller.repository.RenameCommand" />
    <property name="validator">
      <bean class="org.vortikal.web.controller.repository.RenameCommandValidator"
            parent="requestLocalRepositoryAware">
      </bean>
    </property>
  </bean>

  <bean id="ownershipHandler" 
    class="org.vortikal.web.controller.properties.OwnershipController"
    parent="requestLocalRepositoryAware">
    <property name="formView" value="admin" />
    <property name="successView" value="redirect" />
    <property name="commandName" value="ownershipForm" />
    <property name="commandClass" 
              value="org.vortikal.web.controller.properties.OwnershipCommand" />
    <property name="principalFactory" ref="principalFactory" />
  </bean>

  <bean id="aclInheritanceHandler" 
    class="org.vortikal.web.controller.permissions.ToggleAclInheritanceController"
    parent="requestLocalRepositoryAware">
    <property name="viewName" value="redirectToPermissions" />
  </bean>

  <bean id="abstractPermissionsHandler"
        abstract="true"
        class="org.vortikal.web.controller.permissions.ACLEditController"
        parent="requestLocalRepositoryAware">
    <property name="privilegePrincipalMap" ref="editPrivilegePrincipalMap" />
    <property name="formView" value="permissions" />
    <property name="commandClass" value="org.vortikal.web.controller.permissions.ACLEditCommand" />
    <property name="validator">
      <bean class="org.vortikal.web.controller.permissions.ACLEditCommandValidator">
        <property name="principalManager" ref="principalManager" />
        <property name="principalFactory" ref="principalFactory" />
      </bean>
    </property>
    <property name="principalFactory" ref="principalFactory" />
  </bean>

  <bean id="editReadPermissionsHandler" parent="abstractPermissionsHandler">
    <property name="privilege" ref="PRIVILEGE_READ" />
    <property name="successView" value="redirectToPermissions" />
    <property name="commandName" value="permissionsForm_read" />
  </bean>

  <bean id="editWritePermissionsHandler" parent="abstractPermissionsHandler">
    <property name="privilege" ref="PRIVILEGE_WRITE" />
    <property name="successView" value="redirectToPermissions" />
    <property name="commandName" value="permissionsForm_write" />
  </bean>

  <bean id="editAdminPermissionsHandler" parent="abstractPermissionsHandler">
    <property name="privilege" ref="PRIVILEGE_ALL" />
    <property name="successView" value="redirectToPermissions" />
    <property name="commandName" value="permissionsForm_all" />
  </bean>

  <bean id="editBindPermissionsHandler" parent="abstractPermissionsHandler">
    <property name="privilege" ref="PRIVILEGE_BIND" />
    <property name="successView" value="redirectToPermissions" />
    <property name="commandName" value="permissionsForm_bind" />
  </bean>

  <bean id="editReadProcessedPermissionsHandler" parent="abstractPermissionsHandler">
    <property name="privilege" ref="PRIVILEGE_READ_PROCESSED" />
    <property name="successView" value="redirectToPermissions" />
    <property name="commandName" value="permissionsForm_read-processed" />
  </bean>

  <bean id="editAddCommentPermissionsHandler" parent="abstractPermissionsHandler">
    <property name="privilege" ref="PRIVILEGE_ADD_COMMENT" />
    <property name="successView" value="redirectToPermissions" />
    <property name="commandName" value="permissionsForm_add-comment" />
  </bean>

  <bean id="permissionsHandler" 
    class="org.vortikal.web.controller.ResourceAwareParameterizableViewController"
    parent="requestLocalRepositoryAware">
    <property name="viewName" value="permissions" />
  </bean>

  <bean id="editPrivilegePrincipalMap" class="java.util.HashMap">
    <constructor-arg>
      <map>
        <entry key-ref="PRIVILEGE_READ" value-ref="PRINCIPAL_ALL" />
        <entry key-ref="PRIVILEGE_WRITE" value-ref="PRINCIPAL_AUTHENTICATED" />
        <entry key-ref="PRIVILEGE_ALL" value-ref="PRINCIPAL_AUTHENTICATED" />
        <entry key-ref="PRIVILEGE_ADD_COMMENT" value-ref="PRINCIPAL_AUTHENTICATED" />
        <entry key-ref="PRIVILEGE_BIND" value-ref="PRINCIPAL_AUTHENTICATED" />
        <entry key-ref="PRIVILEGE_READ_PROCESSED" value-ref="PRINCIPAL_ALL" />
      </map>
    </constructor-arg>
  </bean>

  <bean id="setResourcePropertyController"
        class="org.vortikal.web.controller.properties.SetResourcePropertyController"
        parent="requestLocalRepositoryAware">
    <property name="formView" value="admin" />
    <property name="successView" value="redirect" />
    <property name="commandName" value="setResourcePropertyForm" />
    <property name="commandClass"
              value="org.vortikal.web.controller.properties.ResourcePropertyCommand" />
  </bean>

  <bean id="deleteResourcePropertyController"
        class="org.vortikal.web.controller.properties.DeleteResourcePropertyController"
        parent="requestLocalRepositoryAware">
    <property name="formView" value="admin" />
    <property name="successView" value="redirect" />
    <property name="commandName" value="deleteResourcePropertyForm" />
    <property name="commandClass"
              value="org.vortikal.web.controller.properties.ResourcePropertyCommand" />
  </bean>

  <bean id="setContentTypeController" 
        class="org.vortikal.web.controller.properties.ContentTypeController"
        parent="requestLocalRepositoryAware">
    <property name="formView" value="admin" />
    <property name="successView" value="redirect" />
    <property name="commandName" value="editContentTypeForm" />
    <property name="commandClass"
              value="org.vortikal.web.controller.properties.ContentTypeCommand" />
  </bean>

  <bean id="setContentLanguageController" 
        class="org.vortikal.web.controller.properties.ContentLanguageController"
        parent="requestLocalRepositoryAware">
    <property name="formView" value="admin" />
    <property name="successView" value="redirect" />
    <property name="commandName" value="editContentLanguageForm" />
    <property name="commandClass"
              value="org.vortikal.web.controller.properties.ContentLanguageCommand" />
    <!-- Using java locale codes to store language -->
    <property name="possibleLanguages">
      <list>
        <value>unknown</value>
        <value>no_NO</value>
        <value>en</value>
        <value>no_NO_NY</value>
      </list>
    </property>
  </bean>

  <bean id="setCharacterEncodingController" 
        class="org.vortikal.web.controller.properties.CharacterEncodingController"
        parent="requestLocalRepositoryAware">
    <property name="formView" value="admin" />
    <property name="successView" value="redirect" />
    <property name="commandName" value="editCharacterEncodingForm" />
    <property name="commandClass"
              value="org.vortikal.web.controller.properties.CharacterEncodingCommand" />
  </bean>

  <bean id="manageCollectionListingHandler" 
    class="org.vortikal.web.controller.ResourceAwareParameterizableViewController"
    parent="requestLocalRepositoryAware">
    <property name="viewName" value="manageCollectionListing" />
  </bean>

  <bean id="previewIframeHandler"
        class="org.vortikal.web.controller.ResourceServiceURLController"
        parent="requestLocalRepositoryAware">
    <property name="viewName" value="previewIframe" />
    <property name="service" ref="viewService"/>
  </bean>

  <bean id="previewImageHandler"
        class="org.vortikal.web.controller.ResourceServiceURLController"
        parent="requestLocalRepositoryAware">
    <property name="viewName" value="previewImage" />
    <property name="service" ref="viewService"/>
  </bean>

  <bean id="previewTextHandler"
        class="org.vortikal.web.controller.DisplayResourceController"
        parent="requestLocalRepositoryAware">
    <!-- XXX preview size limit.. -->
    <property name="ignoreLastModified" value="true" />
    <property name="viewName" value="previewText" />
    <property name="streamToString" value="true" />
  </bean>

  <bean id="previewFallbackHandler"
        class="org.vortikal.web.controller.DisplayResourceController"
        parent="requestLocalRepositoryAware">
    <property name="ignoreLastModified" value="true" />
    <property name="viewName" value="previewFallback" />
  </bean>

  <!-- MANAGE views -->

  <bean id="adminViewResolver" 
        parent="system.decoratingViewResolver">
    <property name="views">
      <map>
        <entry key="manageCollectionListing" 
               value-ref="manageCollectionListingView" />
        <entry key="admin"
               value-ref="aboutView" />
        <entry key="redirectToAbout"
               value-ref="redirectToAboutView" />
        <entry key="permissions"
               value-ref="permissionsView" />
        <entry key="previewImage"
               value-ref="previewImageView" />
        <entry key="previewIframe"
               value-ref="previewIframeView" />
        <entry key="previewText"
               value-ref="previewTextView" />
        <entry key="previewFallback"
               value-ref="previewFallbackView" />
      </map>
    </property>
  </bean>

  <bean id="manage.plainViewResolver"
        class="org.vortikal.web.decorating.MappingViewResolver">
    <property name="views">
      <map>
        <entry key="manage.refreshLockView"
               value-ref="manage.refreshLockView" />
      </map>
    </property>
  </bean>

  <bean id="expiresSecProvider"
        class="org.vortikal.web.referencedata.provider.ResourcePropertiesValueProvider"
        parent="requestLocalRepositoryAware">
    <property name="modelNames">
      <map>
        <entry key="http://www.uio.no/header-control"
               value="expiresSec" />
      </map>
    </property>
    <property name="properties">
      <list>
        <value>http://www.uio.no/header-control:expires-sec</value>
      </list>
    </property>
  </bean>

  <bean id="decorating.manageNamespace" class="java.lang.String">
    <constructor-arg type="java.lang.String" value="manage" />
  </bean>

  <bean id="manage.titleComponent"
        class="org.vortikal.web.decorating.components.ViewRenderingDecoratorComponent">
    <property name="namespace" ref="decorating.manageNamespace" />
    <property name="name" value="title" />
    <property name="description" value="Inserts the admin title" />
    <property name="view" ref="manage.titleView" />
  </bean>

  <bean id="manage.titleView" parent="freemarkerView">
    <property name="url" value="system/title.ftl" />
    <property name="referenceDataProviders">
      <list>
        <ref bean="resourceContextProvider" />
      </list>
    </property>
    <property name="attributesMap">
      <map>
        <entry key="localizationKey" value="title.admin">
        </entry>
      </map>
    </property>
  </bean>

  <bean id="manage.cssComponent"
        class="org.vortikal.web.decorating.components.ViewRenderingDecoratorComponent">
    <property name="namespace" ref="decorating.manageNamespace" />
    <property name="name" value="css" />
    <property name="description" value="Inserts the default admin CSS stylesheets" />
    <property name="view" ref="manage.cssView" />
    <property name="exposeMvcModel" value="true" />
  </bean>

  <bean id="manage.cssView" parent="freemarkerView">
    <property name="url" value="system/css.ftl" />
    <property name="attributesMap">
      <map>
        <entry key="cssURLs">
          <list>
            <value>${themeBaseURL}/admin.css</value>
            <value>${themeBaseURL}/basic.css</value>
            <value>${themeBaseURL}/tabs.css</value>
            <value>${themeBaseURL}/view-container.css</value>
          </list>
        </entry>
      </map>
    </property>
  </bean>

  <bean id="manage.javascriptComponent"
        class="org.vortikal.web.decorating.components.ViewRenderingDecoratorComponent">
    <property name="namespace" ref="decorating.manageNamespace" />
    <property name="name" value="javascript" />
    <property name="description" value="Inserts the default admin javascript references" />
    <property name="view" ref="manage.javascriptView" />
    <property name="exposeMvcModel" value="true" />
  </bean>

  <bean id="manage.javascriptView" parent="freemarkerView">
    <property name="url" value="system/javascript.ftl" />
    <property name="attributesMap">
      <map>
        <entry key="jsURLs">
          <list>
            <value>${jsBaseURL}/browser-sniffer.js</value>
            <value>${jsBaseURL}/admin-enhancements.js</value>
            <value>${jsBaseURL}/../jquery/jquery-1.2.6.js</value>
            <value>${jsBaseURL}/featured-articles-multiple-properties.js</value>
            <value>${jsBaseURL}/admin-edit-display-articles.js</value>
          </list>
        </entry>
      </map>
    </property>
  </bean>

  <bean id="manage.breadcrumbComponent"
        class="org.vortikal.web.decorating.components.ViewRenderingDecoratorComponent">
    <property name="namespace" ref="decorating.manageNamespace" />
    <property name="name" value="breadcrumb" />
    <property name="description" value="Displays the admin breadcrumb trail" />
    <property name="view" ref="manageBreadcrumbView" />
  </bean>

  <bean id="manageBreadcrumbView" parent="freemarkerView">
    <property name="url" value="layouts/breadcrumb.ftl" />
    <property name="referenceDataProviders">
      <list>
        <bean class="org.vortikal.web.referencedata.provider.BreadCrumbProvider" 
              parent="requestLocalRepositoryAware">
          <description>
            Breadcrumb provider that generates links to the manage service
          </description>
          <property name="breadcrumbName" value="breadcrumb" />
          <property name="service" ref="manageService"/>
        </bean>
      </list>
    </property>
  </bean>

  <bean id="manage.leaveAdminComponent"
        class="org.vortikal.web.decorating.components.ViewRenderingDecoratorComponent">
    <property name="namespace" ref="decorating.manageNamespace" />
    <property name="name" value="leave-admin" />
    <property name="description" value="Displays a link to get out of the admin service" />
    <property name="view" ref="manage.leaveAdminView" />
  </bean>

  <bean id="manage.leaveAdminView" parent="freemarkerView">
    <property name="url" value="system/leave-admin.ftl" />
    <property name="referenceDataProviders">
      <list>
        <ref bean="leaveAdminLinkProvider" />
      </list>
    </property>
  </bean>

  <bean id="manage.principalInfoComponent"
        class="org.vortikal.web.decorating.components.ViewRenderingDecoratorComponent">
    <property name="namespace" ref="decorating.manageNamespace" />
    <property name="name" value="principal-info" />
    <property name="description" value="Displays prinncipal information and logout URL" />
    <property name="view" ref="manage.principalInfoView" />
  </bean>

  <bean id="manage.principalInfoView" parent="freemarkerView">
    <property name="url" value="system/principal-info.ftl" />
    <property name="referenceDataProviders">
      <list>
        <ref bean="resourceContextProvider" />
        <ref bean="logoutLinkProvider" />
      </list>
    </property>
  </bean>

  <bean id="logoutLinkProvider"
        class="org.vortikal.web.referencedata.provider.ResourceServiceURLProvider"
        parent="requestLocalRepositoryAware">
    <property name="service" ref="logoutService" />
    <property name="modelName" value="logout" />
    <property name="matchAssertions" value="true" />
  </bean>

  <bean id="manage.repositoryIdComponent" class="org.vortikal.web.decorating.components.StaticTextComponent">
    <property name="namespace" ref="decorating.manageNamespace" />
    <property name="name" value="repository-id" />
    <property name="text" value="${repositoryID}" />
  </bean>

  <bean id="manage.helpComponent"
        class="org.vortikal.web.decorating.components.ViewRenderingDecoratorComponent">
    <property name="namespace" ref="decorating.manageNamespace" />
    <property name="name" value="help" />
    <property name="description" value="Displays a help link for the admin service" />
    <property name="view" ref="manage.helpView" />
  </bean>

  <bean id="manage.helpView" parent="freemarkerView">
    <property name="url" value="system/help.ftl" />
    <property name="attributesMap">
      <map>
        <entry key="helpURL" value="${helpURL}" />
      </map>
    </property>
  </bean>

  <bean id="manage.localizedTextComponent"
        class="org.vortikal.web.decorating.components.LocalizedTextComponent">
    <property name="namespace" ref="decorating.manageNamespace" />
    <property name="name" value="localized-text" />
  </bean>

  <bean id="manage.lockInfoComponent"
        class="org.vortikal.web.decorating.components.ViewRenderingDecoratorComponent">
    <property name="namespace" ref="decorating.manageNamespace" />
    <property name="name" value="lock-info" />
    <property name="description" value="Displays lock information" />
    <property name="view" ref="manageLockInfoView" />
  </bean>

  <bean id="manageLockInfoView" parent="freemarkerView">
    <property name="url" value="layouts/lock.ftl" />
    <property name="referenceDataProviders">
      <list>
        <ref bean="resourceContextProvider" />
        <ref bean="lockUnlockActionsProvider" />      
      </list>
    </property>
  </bean>

  <bean id="manage.messagesComponent"
        class="org.vortikal.web.decorating.components.ViewRenderingDecoratorComponent">
    <property name="namespace" ref="decorating.manageNamespace" />
    <property name="name" value="messages" />
    <property name="description" value="Displays the admin messages" />
    <property name="view" ref="manage.messagesView" />
  </bean>

  <bean id="manage.messagesView" parent="freemarkerView">
    <property name="url" value="system/messages.ftl" />
    <property name="referenceDataProviders">
      <list>
        <ref bean="resourceContextProvider" />
        <ref bean="expiresSecProvider" />
      </list>
    </property>
  </bean>

  
  <bean id="manage.infoMessageComponent"
        class="org.vortikal.web.decorating.components.ViewRenderingDecoratorComponent">
    <property name="namespace" ref="decorating.manageNamespace" />
    <property name="name" value="info-message" />
    <property name="description" value="Displays an info message (if found in its specified location)" />
    <property name="view" ref="manage.infoMessageView" />
  </bean>

  <bean id="manage.infoMessageView" parent="freemarkerView">
    <property name="url" value="system/info-message.ftl" />
    <property name="referenceDataProviders">
      <list>
	<bean class="org.vortikal.web.referencedata.provider.SpringResourceContentProvider">
	  <property name="modelKey" value="systemInfoMessage" />
	  <property name="location" value="${manage.infoMessageLocation}" />
	</bean>
      </list>
    </property>
  </bean>



  <bean id="manage.resourceHeaderComponent"
        class="org.vortikal.web.decorating.components.ViewRenderingDecoratorComponent">
    <property name="namespace" ref="decorating.manageNamespace" />
    <property name="name" value="resource-header" />
    <property name="description" value="Displays the resource name or repository ID for root" />
    <property name="view" ref="manage.resourceHeaderView" />
    <property name="exposeMvcModel" value="true" />
  </bean>

  <bean id="manage.resourceHeaderView" parent="freemarkerView">
    <property name="url" value="system/resource-header.ftl" />
    <property name="referenceDataProviders">
      <ref bean="resourceContextProvider" />
    </property>
    <property name="attributesMap">
      <map>
        <entry key="repositoryID" value="${repositoryID}" />
      </map>
    </property>
  </bean>

  <bean id="manage.globalMenuComponent"
        class="org.vortikal.web.decorating.components.ViewRenderingDecoratorComponent">
    <property name="namespace" ref="decorating.manageNamespace" />
    <property name="name" value="global-menu" />
    <property name="description" value="Displays the admin global menu" />
    <property name="view" ref="manage.globalMenuView" />
    <property name="exposeMvcModel" value="true" />
  </bean>

  <bean id="manage.globalMenuView" parent="freemarkerView">
    <property name="url" value="system/global-menu.ftl" />
    <property name="referenceDataProviders">
      <list>
        <ref bean="resourceContextProvider" />
        <ref bean="resourceMenuProvider" />
      </list>
    </property>
  </bean>

  <bean id="manage.tabsComponent"
        class="org.vortikal.web.decorating.components.ViewRenderingDecoratorComponent">
    <property name="namespace" ref="decorating.manageNamespace" />
    <property name="name" value="tabs" />
    <property name="description" value="Displays the default admin tabs" />
    <property name="view" ref="manageTabView" />
  </bean>

  <bean id="manageTabView" parent="freemarkerView">
    <property name="url" value="layouts/tabs.ftl" />
    <property name="referenceDataProviders">
      <list>
        <ref bean="tabsProvider" />
      </list>
    </property>
  </bean>

  <bean id="manage.tabMenuComponent"
        class="org.vortikal.web.decorating.components.ViewRenderingDecoratorComponent">
    <property name="namespace" ref="decorating.manageNamespace" />
    <property name="name" value="tab-menu" />
    <property name="description" value="Displays the admin tab menu" />
    <property name="view" ref="manage.tabMenuView" />
    <property name="exposeMvcModel" value="true" />
  </bean>

  <bean id="manage.tabMenuView" parent="freemarkerView">
    <property name="url" value="system/tab-menu.ftl" />
  </bean>

  <bean id="manage.tabMessageComponent"
        class="org.vortikal.web.decorating.components.ViewRenderingDecoratorComponent">
    <property name="namespace" ref="decorating.manageNamespace" />
    <property name="name" value="tab-message" />
    <property name="description" value="Displays the admin tab message" />
    <property name="view" ref="manage.tabMessageView" />
    <property name="exposeMvcModel" value="true" />
  </bean>

  <bean id="manage.tabMessageView" parent="freemarkerView">
    <property name="url" value="system/tab-message.ftl" />
  </bean>

  <bean id="manage.parentNavigationComponent"
        class="org.vortikal.web.decorating.components.ViewRenderingDecoratorComponent">
    <property name="namespace" ref="decorating.manageNamespace" />
    <property name="name" value="parent-navigation" />
    <property name="description" value="Displays the parent collection URL" />
    <property name="view" ref="manage.parentNavigationView" />
    <property name="exposeMvcModel" value="true" />
  </bean>

  <bean id="manage.parentNavigationView" parent="freemarkerView">
    <property name="url" value="system/parent-navigation.ftl" />
  </bean>

  <bean id="manage.tabHelpComponent"
        class="org.vortikal.web.decorating.components.ViewRenderingDecoratorComponent">
    <property name="namespace" ref="decorating.manageNamespace" />
    <property name="name" value="tab-help" />
    <property name="description" value="Displays a tab help message" />
    <property name="view" ref="manage.tabHelpView" />
    <property name="exposeMvcModel" value="true" />
  </bean>

  <bean id="manage.tabHelpView" parent="freemarkerView">
    <property name="url" value="system/tab-help.ftl" />
  </bean>

  <bean id="manage.versionInfoComponent"
        class="org.vortikal.web.decorating.components.ViewRenderingDecoratorComponent">
    <property name="namespace" ref="decorating.manageNamespace" />
    <property name="name" value="version-info" />
    <property name="description" value="Displays version information" />
    <property name="view" ref="manage.versionInfoView" />
  </bean>

  <bean id="manage.versionInfoView" parent="freemarkerView">
    <property name="url" value="system/version-info.ftl" />
    <property name="referenceDataProviders">
      <list>
        <ref bean="versionProvider" /> 
      </list>
    </property>
  </bean>
  
  <bean id="manage.languageSelectComponent"
        class="org.vortikal.web.decorating.components.ViewRenderingDecoratorComponent">
    <property name="namespace" ref="decorating.manageNamespace" />
    <property name="name" value="language-select" />
    <property name="description" value="Displays the admin language" />
    <property name="view" ref="manage.languageSelectView" />
    <property name="exposeMvcModel" value="true" />
  </bean>

  <bean id="manage.languageSelectView" parent="freemarkerView">
    <property name="url" value="system/language-select.ftl" />
    <property name="referenceDataProviders">
      <ref bean="switchLocaleActionsProvider" />
    </property>
  </bean>

  <bean id="manageLinkProvider"
        class="org.vortikal.web.referencedata.provider.ResourceServiceURLProvider"
        parent="requestLocalRepositoryAware">
    <property name="modelName" value="manageLink" />
    <property name="service" ref="manageService" />
  </bean>

  <bean id="manage.refreshLockURLProvider" class="org.vortikal.web.referencedata.provider.ResourceServiceURLProvider">
    <property name="repository" ref="repository" />
    <property name="service" ref="manage.refreshLockService" />
    <property name="modelName" value="pingURL" />
    <property name="urlName" value="url" />
  </bean>

  <bean id="manage.unlockURLProvider" class="org.vortikal.web.referencedata.provider.ResourceServiceURLProvider">
    <property name="repository" ref="repository" />
    <property name="service" ref="unlockResourceService" />
    <property name="modelName" value="unlockURL" />
    <property name="urlName" value="url" />
  </bean>

  <bean id="manage.refreshLockView" parent="freemarkerView">
    <property name="url" value="layouts/lock-refresh-response.ftl" />
  </bean>

  <!-- Views -->

  <bean id="previewImageView" parent="freemarkerView">
    <property name="url" value="pages/preview-image.ftl" />
    <property name="referenceDataProviders">
      <list>
        <ref bean="resourceContextProvider" />
      </list>
    </property>
  </bean>

  <bean id="previewIframeView" parent="freemarkerView">
    <property name="url" value="pages/preview-iframe.ftl" />
    <property name="referenceDataProviders">
      <list>
        <ref bean="iframeJSProvider" />
        <ref bean="resourceContextProvider" />
      </list>
    </property>
  </bean>
  
  <bean id="previewTextView" parent="freemarkerView">
    <property name="url" value="pages/preview-text.ftl" />
    <property name="referenceDataProviders">
      <list>
        <ref bean="resourceContextProvider" />
      </list>
    </property>
  </bean>
  
  <bean id="previewFallbackView" parent="freemarkerView">
    <property name="url" value="pages/preview-unavailable.ftl" />
    <property name="referenceDataProviders">
      <list>
        <ref bean="resourceContextProvider" />
        <ref bean="resourceDetailProvider" />
      </list>
    </property>
  </bean>

  <bean id="permissionsView" parent="freemarkerView">
    <property name="url" value="pages/permissions.ftl" />
    <property name="referenceDataProviders">
      <list>
        <ref bean="adminACLProvider" />
        <ref bean="resourceContextProvider" />
      </list>
    </property>
  </bean>

  <bean id="redirectToAboutView"
    class="org.vortikal.web.view.RedirectView">
    <description>Standard HTTP redirect view to the manage service</description>
    <property name="referenceDataProviders">
      <list>
        <ref bean="redirectToAboutProvider" />
      </list>
    </property>
  </bean>

  <bean id="redirectToAboutProvider" 
        class="org.vortikal.web.referencedata.provider.RedirectProvider"
        parent="requestLocalRepositoryAware">
    <property name="redirectToService" ref="aboutResourceService" />
  </bean>

  <bean id="aboutView" parent="freemarkerView">
    <property name="url" value="pages/about.ftl" />
    <property name="referenceDataProviders">
      <list>
        <ref bean="resourceContextProvider" />
        <ref bean="aboutResourceHandler" /> 
        <ref bean="resourceDetailProvider" />
      </list>
    </property>
  </bean>

  <bean id="manageCollectionListingView" parent="freemarkerView">
    <property name="url" value="pages/manage-collectionlisting.ftl" />
    <property name="referenceDataProviders">
      <list>
        <ref bean="parentLinkProvider" /> 
        <ref bean="collectionMenuProvider" /> 
        <ref bean="manageCollectionlistingProvider" />

        <ref bean="resourceContextProvider" />
        <ref bean="collectionMenuProvider" />

      </list>
    </property>
  </bean>

  <!-- Static files for manage service: -->
  
  <bean id="managetStaticResourceLocation" class="org.vortikal.web.StaticResourceLocation">
    <property name="uriPrefix" value="${webResources.baseURL}" />
    <property name="resourceLocation" value="${webResources.physicalLocation}" />
  </bean>

  <!-- Manage specific providers -->

  <bean id="iframeJSProvider"
        class="org.vortikal.web.referencedata.provider.StaticModelDataProvider">
    <property name="modelDataMap">
      <map>
        <entry key="jsURLs"> 
          <list>
            <value>${jsBaseURL}/browser-sniffer.js</value>
            <value>${jsBaseURL}/admin-enhancements.js</value>
            <value>${jsBaseURL}/../jquery/jquery-1.2.6.js</value>
            <value>${jsBaseURL}/iframe.js</value>
          </list>
        </entry>
      </map>
    </property>
  </bean>
  
  <bean id="adminACLProvider" 
        class="org.vortikal.web.referencedata.provider.ACLProvider" 
        parent="requestLocalRepositoryAware">
    <property name="aclInheritanceService"  ref="aclInheritanceService" />
    <property name="aclEditServices">
      <map>
        <entry key-ref="PRIVILEGE_READ" value-ref="editReadPermissionsService" />
        <entry key-ref="PRIVILEGE_WRITE" value-ref="editWritePermissionsService" />
        <entry key-ref="PRIVILEGE_ALL" value-ref="editAdminPermissionsService" />
        <entry key-ref="PRIVILEGE_ADD_COMMENT" value-ref="editAddCommentPermissionsService" />
        <entry key-ref="PRIVILEGE_BIND" value-ref="editBindPermissionsService" />
        <entry key-ref="PRIVILEGE_READ_PROCESSED" value-ref="editReadProcessedPermissionsService" />
      </map>
    </property>
    <property name="groupingPrivilegePrincipalMap" ref="editPrivilegePrincipalMap" />
  </bean>

  <bean id="manageCollectionlistingProvider" 
        class="org.vortikal.web.referencedata.provider.CollectionListingProvider" 
        parent="requestLocalRepositoryAware" >
    <property name="browsingService" ref="manageService" />
    <property name="childInfoItems">
      <list>
        <value>name</value>
        <value>owner</value>
        <value>content-length</value>
        <value>locked</value>
        <value>last-modified</value>
      </list>
    </property>
    <property name="linkedServices">
      <map>
        <entry key="delete" value-ref="deleteResourceService" />
        <!-- entry key="duplicate" value-ref="duplicateResourceService" / -->
      </map>
    </property>
    <property name="retrieveForProcessing" value="false" />
  </bean>

  <bean id="collectionMenuProvider" 
    class="org.vortikal.web.view.components.menu.DefaultListMenuProvider" lazy-init="true">
    <constructor-arg ref="collectionActionServicesFactory" />
    <constructor-arg value="tabMenu2" />
    <constructor-arg ref="repository.requestLocal" />
  </bean>

  <bean id="collectionActionServicesFactory"
    class="org.vortikal.context.CategoryResolvingFactoryBean"
        lazy-init="true">
    <property name="clazz" value="org.vortikal.web.service.Service" />
    <property name="category" value="collectionMenu" />
  </bean>

  <bean id="resourceMenuProvider" 
    class="org.vortikal.web.view.components.menu.DefaultListMenuProvider">
    <constructor-arg ref="resourceActionServicesFactory" />
    <constructor-arg value="globalMenu" />
    <constructor-arg ref="repository.requestLocal" />
  </bean>

  <bean id="resourceActionServicesFactory"
    class="org.vortikal.context.CategoryResolvingFactoryBean">
    <property name="clazz" value="org.vortikal.web.service.Service" />
    <property name="category" value="resourceMenu" />
    <property name="comparator">
      <bean class="org.vortikal.web.service.ServiceAttributeComparator">
        <property name="attributeName" value="resourceMenuOrder" />
      </bean>
    </property>
  </bean>

  <bean id="manageBreadCrumbProvider" 
        class="org.vortikal.web.referencedata.provider.BreadCrumbProvider" 
        parent="requestLocalRepositoryAware">
    <description>
      Breadcrumb provider that generates links to the manage service
    </description>
    <property name="breadcrumbName" value="manageBreadCrumb" />
    <property name="service" ref="manageService"/>
  </bean>

  <bean id="versionProvider" 
        class="org.vortikal.web.referencedata.provider.ParameterizableBeanProvider" >
    <property name="modelName" value="version" />
    <property name="object">
      <bean class="org.vortikal.util.Version">
      </bean>
    </property>
  </bean>

  <!-- MANAGE assertions -->

  <bean id="requiresReadPermissionAssertion"
        parent="abstractResourcePrincipalPermissionAssertion">
    <property name="requiresAuthentication" value="true" />
    <property name="permission" ref="ACTION_READ" />
  </bean>

  <bean id="requiresWritePermissionAssertion" 
        parent="abstractResourcePrincipalPermissionAssertion">
    <property name="requiresAuthentication" value="true" />
    <property name="permission" ref="ACTION_WRITE" />
  </bean>

  <bean id="deleteResourcePermissionAssertion"
        parent="abstractResourcePrincipalPermissionAssertion">
    <property name="permission" ref="ACTION_DELETE" />
    <property name="requiresAuthentication" value="true" />
  </bean>

  <bean id="writePermissionAssertion"
        parent="abstractResourcePrincipalPermissionAssertion">
    <property name="permission" ref="ACTION_WRITE" />
  </bean>

  <bean id="bindPermissionAssertion"
        parent="abstractResourcePrincipalPermissionAssertion">
    <property name="permission" ref="ACTION_CREATE" />
  </bean>

  <bean id="writeACLPermissionAssertion"
        parent="abstractResourcePrincipalPermissionAssertion">
    <property name="permission" ref="ACTION_WRITE_ACL" />
  </bean>

  <bean id="readProcessedPermissionAssertion"
        parent="abstractResourcePrincipalPermissionAssertion">
    <property name="requiresAuthentication" value="true" />
    <property name="permission" ref="ACTION_READ_PROCESSED" />
  </bean>

  <bean id="unlockPermissionAssertion"
        parent="abstractResourcePrincipalPermissionAssertion">
    <property name="permission" ref="ACTION_UNLOCK" />
  </bean>

  <bean id="lockPermissionAssertion"
        parent="abstractResourcePrincipalPermissionAssertion">
    <property name="permission" ref="ACTION_WRITE" />
  </bean>

  <bean id="delegateOwnershipPermissionAssertion"
        parent="abstractResourcePrincipalPermissionAssertion">
    <property name="permission" ref="ACTION_WRITE_ACL" />
  </bean>

  <bean id="resourceNotRootAssertion" 
        class="org.vortikal.web.service.ResourceURIAssertion">
    <property name="uri" value="/" />
    <property name="inverted" value="true" />
  </bean>

  <bean id="adminVrtxParameterRule" class="org.vortikal.web.service.RequestParameterAssertion">
    <property name="parameterName" value="vrtx" />
    <property name="parameterValue" value="admin" />
  </bean>

  <bean id="manage.refreshLockRequestParameter" class="org.vortikal.web.service.RequestParameterAssertion">
    <property name="parameterName" value="action" />
    <property name="parameterValue" value="refresh-lock" />
  </bean>

  <bean id="localeParameterEqualsNO"
        class="org.vortikal.web.service.RequestParameterAssertion">
    <property name="parameterName" value="locale" />
    <property name="parameterValue" value="no" />
  </bean>

  <bean id="localeParameterEqualsNN"
        class="org.vortikal.web.service.RequestParameterAssertion">
    <property name="parameterName" value="locale" />
    <property name="parameterValue" value="nn" />
  </bean>

  <bean id="localeParameterEqualsEN"
        class="org.vortikal.web.service.RequestParameterAssertion">
    <property name="parameterName" value="locale" />
    <property name="parameterValue" value="en" />
  </bean>

  <!-- MANAGE error handlers -->

  <bean id="abstractReferencedataProvidingErrorHandler"
        class="org.vortikal.web.DefaultErrorHandler" abstract="true">
    <property name="referenceDataProviders" ref="standardManageReferenceDataProviders" />
  </bean>

  <bean id="standardManageReferenceDataProviders" class="java.util.ArrayList">
    <constructor-arg>
      <list>
        <ref bean="leaveAdminLinkProvider" />
        <ref bean="tabsProvider" />
        <ref bean="resourceContextProvider" />
        <ref bean="versionProvider" />
        <ref bean="manageBreadCrumbProvider" />
        <ref bean="lockUnlockActionsProvider" />      
        <ref bean="switchLocaleActionsProvider" />
        <ref bean="resourceMenuProvider" /> 
        <ref bean="resourceDetailProvider" />
      </list>
    </constructor-arg>
  </bean>

  <bean id="defaultManageErrorHandler" class="org.vortikal.web.DefaultErrorHandler">
    <property name="service" ref="manageService" />
    <property name="errorViewName" value="defaultManageError" />
    <property name="referenceDataProviders" ref="standardManageReferenceDataProviders" />
    <property name="statusCodeMappings">
      <map>
        <entry key="org.vortikal.repository.ResourceNotFoundException" value="404" />
        <entry key="org.vortikal.repository.AuthorizationException" value="403" />
      </map>
    </property>
  </bean>

  <bean id="manageErrorViewResolver"
        class="org.vortikal.web.decorating.MappingViewResolver">
    <property name="views">
      <map>
        <entry key="defaultManageError" value-ref="defaultManageErrorView" />
      </map>
    </property>
    <property name="viewWrapper" ref="system.viewWrapper" />
  </bean>

  <bean id="defaultManageErrorView" parent="freemarkerView">
    <property name="url" value="pages/error/default-manage-error.ftl" />
  </bean>

  <bean id="requestLocaleNotNorwegianNB"
        class="org.vortikal.web.service.RequestLocaleMatchAssertion">
    <property name="invert" value="true" />
    <property name="locale">
      <bean class="java.util.Locale">
        <constructor-arg><value>no</value></constructor-arg>
      </bean>
    </property>
    <property name="localeResolver" ref="manageLocaleResolver" />
  </bean>
  
  <bean id="requestLocaleNotNorwegianNN"
        class="org.vortikal.web.service.RequestLocaleMatchAssertion">
    <property name="invert" value="true" />
    <property name="locale">
      <bean class="java.util.Locale">
        <constructor-arg><value>nn</value></constructor-arg>
      </bean>
    </property>
    <property name="localeResolver" ref="manageLocaleResolver" />
  </bean>
  
  <bean id="requestLocaleNotEnglish"
        class="org.vortikal.web.service.RequestLocaleMatchAssertion">
    <property name="invert" value="true" />
    <property name="locale">
      <bean class="java.util.Locale">
        <constructor-arg><value>en</value></constructor-arg>
      </bean>
    </property>
    <property name="localeResolver" ref="manageLocaleResolver" />
  </bean>

  <!-- Locale resolver for manage service  -->
  
  <bean id="manageLocaleResolver"
         class="org.springframework.web.servlet.i18n.CookieLocaleResolver" >
    <property name="cookieMaxAge" value="315360000" />
    <property name="defaultLocale"> 
      <bean class="java.util.Locale">
        <constructor-arg value="${manage.defaultLocale}" />
      </bean>
    </property>
  </bean>

  <bean id="noCacheHandlerInterceptor"
        class="org.vortikal.web.controller.HeaderControlHandlerInterceptor">
    <property name="staticHeaders">
      <map>
        <entry key="Cache-Control" value="no-cache, no-store, must-revalidate, max-age=0" />
        <entry key="Expires" value="0" />
        <entry key="Pragma" value="no-cache" />
      </map>
    </property>
  </bean>

</beans>

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">
<beans>

  <!-- 
    To use: 

    1. add to ~/.vrtx-context.xml:

    <import resource="classpath:/vortikal/beans/standard-extensions/saml/saml.xml" />


    2. add to ~/.vrtx.properties:

    webAuthenticationChallenge = saml.authenticationHandler
    saml.authenticationURL = <login url>
    saml.logoutURL = <logout url>
    saml.idpCertificate = <encoded IDP certificate>
    saml.keystorePath = <path to keystore>
    saml.keystorePassword = <keystore password>
    saml.privateKeyAlias = <alias of private key entry in keystore>
    saml.privateKeyPassword = <password of private key entry>
  -->


  <bean id="saml.authenticationHandler" class="org.vortikal.security.web.saml.SamlAuthenticationHandler">
    <property name="principalFactory" ref="principalFactory" />

    <property name="challenge" ref="saml.challenge" />
    <property name="login" ref="saml.login" />
    <property name="logout" ref="saml.logout" />
  </bean>

  <bean id="saml.abstractHandler" abstract="true">
    <property name="certificateManager" ref="saml.certificateManager" />
    <property name="serviceProviderURI" value="${saml.serviceProviderURI}" />
    <property name="privateKeyAlias" value="${saml.privateKeyAlias}" />
    <property name="authenticationURL" value="${saml.authenticationURL}" />
    <property name="logoutURL" value="${saml.logoutURL}" />
    <property name="serviceIdentifier" value="${saml.serviceIdentifier}" />
  </bean>

  <bean id="saml.challenge" class="org.vortikal.security.web.saml.Challenge" parent="saml.abstractHandler" />

  <bean id="saml.login" class="org.vortikal.security.web.saml.Login" parent="saml.abstractHandler">
    <property name="replayMinutes" value="60" />
  </bean>

  <bean id="saml.logout" class="org.vortikal.security.web.saml.Logout" parent="saml.abstractHandler">
    <property name="securityInitializer" ref="securityInitializer" />
  </bean>


  <bean id="saml.certificateManager" class="org.vortikal.security.web.saml.CertificateManager">
    <property name="keystore" value="${saml.keystorePath}" />
    <property name="keystorePassword" value="${saml.keystorePassword}" />
    <property name="privateKeyPassword" value="${saml.privateKeyPassword}" />
    <property name="idpCertificate" value="${saml.idpCertificate}" />
  </bean>

  <!-- 
    - This service serves the purpose of receiving "post-logout" requests from IDP 
    - and then redirecting to the resource from where logout request was initiated
  -->
  <bean id="saml.postLogoutService" class="org.vortikal.web.service.ServiceImpl">
    <property name="order" value="-97000" />
    <property name="assertions">
      <list>
        <bean class="org.vortikal.web.service.RequestPathAssertion">
          <property name="path" value="${saml.serviceProviderURI}" />
        </bean>
      </list>
    </property>
    <property name="handler" ref="saml.authenticationHandler" />
  </bean>
</beans>

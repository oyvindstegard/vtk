<?xml version="1.0" encoding="utf-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd">

  <!-- Media periodic job -->
  <bean id="repository.systemjob.mediaMetadataJob" class="org.vortikal.repository.systemjob.MediaMetadataJob" parent="repository.systemjob" depends-on="resourceTypeTree">
    <property name="triggerExpression" value="${repository.media.generator.interval}" />
    <property name="id" value="media-metadata-generator" />
    <property name="pathSelector">
      <bean class="org.vortikal.repository.systemjob.IndexQueryPathSelector" parent="repository.systemjob.indexPathSelector">
        <property name="limit" value="${repository.media.generator.batch}" />
        <property name="queryString">
          <value>
            (type IN video OR type IN audio OR type IN image) AND media-metadata-status = GENERATE
          </value>
        </property>
      </bean>
    </property>
    <property name="affectedPropDefPointers">
      <list>
        <value>thumbnail</value>
        <value>generated-poster-image</value>
        <value>duration</value>
        <value>pixelHeight</value>
        <value>pixelWidth</value>
        <value>media-metadata-status</value>
      </list>
    </property>
    <property name="mediaMetadataProvider" ref="repository.systemjob.remoteMetadataProvider" />
  </bean>
  
  <bean id="repository.systemjob.remoteMetadataProvider" class="org.vortikal.repository.systemjob.RemoteMetadataProvider">
    <property name="username" value="${vms.username}" />
    <property name="password" value="${vms.password}" />
    <property name="resourceTypeTree" ref="resourceTypeTree" />
    <property name="protocol" value="http" />
    <property name="host" value="localhost" />
    <property name="port" value="6666" />
    <property name="thumbnailSize" value="${resourcetype.image.thumbnail.width}" />
    <property name="repositoryDataDirectory" value="${repositoryDataDirectory}" />
    <property name="thumbnailPropDef" ref="thumbnailPropDef" />
    <property name="posterImagePropDef" ref="generatedPosterImagePropDef" />
    <property name="mediaWidthPropDef" ref="mediaWidthPropDef" />
    <property name="mediaHeightPropDef" ref="mediaHeightPropDef" />
    <property name="mediaMetadataStatusPropDef" ref="mediaMetadataStatusPropDef" />
    <property name="maxSourceImageFileSize" value="${resourcetype.image.thumbnail.maxSourceImageFileSize}" />
    <property name="maxSourceImageRawMemoryUsage" value="${resourcetype.image.thumbnail.maxSourceImageRawMemoryUsage}" />
    <property name="scaleUp" value="false" />
    <!-- Image -->
    <property name="imageThumbnailParameters">
      <map>
        <entry key="action" value="thumbnail" />
        <entry key="filetype" value="image" />
        <entry key="width" value="${resourcetype.image.thumbnail.width}" />
      </map>
    </property>
    <property name="imageMetadataParameters">
      <map>
        <entry key="action" value="metadata" />
        <entry key="filetype" value="image" />
      </map>
    </property>
    <property name="imageMetadataAffectedPropDefPointers">
      <list>
        <value>pixelHeight</value>
        <value>pixelWidth</value>
      </list>
    </property>
    <!-- Video -->
    <property name="videoThumbnailParameters">
      <map>
        <entry key="action" value="thumbnail" />
        <entry key="filetype" value="video" />
        <entry key="width" value="${resourcetype.image.thumbnail.width}" />
      </map>
    </property>
    <property name="videoMetadataParameters">
      <map>
        <entry key="action" value="metadata" />
        <entry key="filetype" value="video" />
      </map>
    </property>
    <property name="videoPosterImageParameters">
      <map>
        <entry key="action" value="thumbnail" />
        <entry key="filetype" value="video" />
      </map>
    </property>
    <property name="videoMetadataAffectedPropDefPointers">
      <list>
        <value>duration</value>
        <value>pixelHeight</value>
        <value>pixelWidth</value>
      </list>
    </property>
    <!-- Audio -->
    <property name="audioMetadataParameters">
      <map>
        <entry key="action" value="metadata" />
        <entry key="filetype" value="audio" />
      </map>
    </property>
    <property name="audioMetadataAffectedPropDefPointers">
      <list>
        <value>duration</value>
      </list>
    </property>
  </bean>

</beans>

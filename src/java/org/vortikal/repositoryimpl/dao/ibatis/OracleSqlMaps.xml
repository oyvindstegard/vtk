<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">
<sqlMap>

  <insert id="oracle.insertResource" parameterClass="java.util.Map">
    insert into vortex_resource 
      (resource_id,
       uri,
       resource_type,
       content_length,
       depth,
       creation_time,
       content_last_modified,
       properties_last_modified,
       content_modified_by,
       properties_modified_by,
       resource_owner,
       display_name,
       content_language,
       content_type,
       character_encoding,
       guessed_character_encoding,
       user_character_encoding,
       is_collection,
       acl_inherited_from,
       created_by,
       modified_by,
       last_modified)

    values 
      (vortex_resource_seq_pk.nextval,
       #uri#,
       #resourceType#,
       #contentLength#,
       #depth#,
       #creationTime#,
       #contentLastModified#,
       #propertiesLastModified#,
       #contentModifiedBy#,
       #propertiesModifiedBy#,
       #owner#,
       #displayName#,
       #contentLanguage#, 
       #contentType#,
       #characterEncoding#,
       #guessedCharacterEncoding#,
       #userSpecifiedCharacterEncoding#,
       #collection#,
       #aclInheritedFrom#,
       #createdBy#,
       #modifiedBy#,
       #lastModified#)
  </insert>
  

  <insert id="oracle.copyResource" parameterClass="java.util.Map">
    insert into vortex_resource 
      (resource_id,
       uri,
       prev_resource_id,
       resource_type,
       content_length,
       depth,
       creation_time,
       content_last_modified,
       properties_last_modified,
       content_modified_by,
       properties_modified_by,
       resource_owner,
       display_name,
       content_language,
       content_type,
       character_encoding,
       guessed_character_encoding,
       user_character_encoding,
       is_collection,
       acl_inherited_from,
       created_by,
       modified_by,
       last_modified)

    select
      vortex_resource_seq_pk.nextval,
      #destUri# || substr(uri, length(#uri#) + 1),
      resource_id,
      resource_type,
      content_length,
      depth + #depthDiff#,
      creation_time,
      content_last_modified,
      properties_last_modified,
      content_modified_by,
      properties_modified_by,
      <isPropertyAvailable property="owner">#owner#,</isPropertyAvailable>
      <isNotPropertyAvailable property="owner">resource_owner,</isNotPropertyAvailable>
      display_name,
      content_language,
      content_type,
      character_encoding,
      guessed_character_encoding,
      user_character_encoding,
      is_collection,
      acl_inherited_from,
      created_by,
      modified_by,
      last_modified
    from vortex_resource
    where uri = #uri# or uri like #uriWildcard#
  </insert>


  <insert id="oracle.insertPropertyEntry" parameterClass="java.util.Map">
    insert into extra_prop_entry
      (extra_prop_entry_id, resource_id, prop_type_id, name_space, name, value)
    values (extra_prop_entry_seq_pk.nextval, #resourceId#, #type#,
            #namespaceUri#, #name#, #value#)
  </insert>


  <insert id="oracle.copyProperties" parameterClass="java.util.Map">
    insert into extra_prop_entry
      (extra_prop_entry_id,
       resource_id,
       prop_type_id,
       name_space,
       name,
       value)
    select
      extra_prop_entry_seq_pk.nextval, t.*
      from
        (select
          r.resource_id,
          p.prop_type_id,
          p.name_space,
          p.name,
          p.value
        from vortex_resource r inner join extra_prop_entry p 
             on r.prev_resource_id = p.resource_id
        where (r.uri = #destUri# or r.uri like #destUriWildcard#)
          and r.prev_resource_id is not null
          order by p.extra_prop_entry_id) t
  </insert>    


  <insert id="oracle.insertAclEntry" parameterClass="java.util.Map">
    insert into acl_entry
      (acl_entry_id, action_type_id, resource_id, user_or_group_name,
       is_user, granted_by_user_name, granted_date)
    values (acl_entry_seq_pk.nextval, #actionId#, #resourceId#, #principal#,
            #isUser#, #grantedBy#, #grantedDate#)
  </insert>

  
  <insert id="oracle.copyAclEntries" parameterClass="java.util.Map">
    insert into acl_entry
      (acl_entry_id,
       resource_id,
       action_type_id,
       user_or_group_name,
       is_user,
       granted_by_user_name,
       granted_date)
     select
       acl_entry_seq_pk.nextval,
       r.resource_id,
       a.action_type_id,
       a.user_or_group_name,
       a.is_user,
       a.granted_by_user_name,
       a.granted_date
     from vortex_resource r inner join acl_entry a
       on r.prev_resource_id = a.resource_id 
     where (r.uri = #destUri#  or r.uri like #destUriWildcard#)
            and r.prev_resource_id is not null
  </insert>

  <insert id="oracle.insertLock" parameterClass="java.util.Map">
    insert into vortex_lock
      (lock_id, token, resource_id, lock_owner,
       lock_owner_info, depth, timeout)
     values (vortex_lock_seq_pk.nextval,
            #lockToken#, #resourceId#, #owner#,
            #ownerInfo#, #depth#, #timeout#)
  </insert>


  <insert id="oracle.insertChangelogEntriesRecursively" parameterClass="java.util.Map">
    insert into changelog_entry 
      (changelog_entry_id, logger_id, logger_type,
      operation, timestamp, uri, resource_id, is_collection)
    select changelog_entry_seq_pk.nextval, #loggerId#, #loggerType#,
      #operation#, sysdate, uri, resource_id, is_collection 
    from vortex_resource 
    where uri = #uri# or uri like #uriWildcard#
  </insert>


  <insert id="oracle.insertChangelogEntry" parameterClass="java.util.Map">
    insert into changelog_entry 
      (changelog_entry_id, logger_id, logger_type,
      operation, timestamp, uri, resource_id, is_collection)
    values (changelog_entry_seq_pk.nextval, #loggerId#, #loggerType#,
      #operation#, sysdate, #uri#, #resourceId#, #collection#)
  </insert>

  <update id="oracle.updateAclInheritedFromByPreviousResourceId" parameterClass="java.util.Map">
    update vortex_resource r1
      set (acl_inherited_from) =
        (select r2.resource_id
          from vortex_resource r2
          where r2.prev_resource_id = r1.acl_inherited_from)
    where (r1.uri = #uri# or r1.uri like #uriWildcard#)
           and r1.acl_inherited_from is not null
           and r1.acl_inherited_from != #inheritedFrom#
  </update>
  
  <select id="oracle.nextTempTableSessionId" resultClass="java.lang.Integer">
    select vortex_uri_tmp_session_id_seq.nextval from dual
  </select>
  

</sqlMap>

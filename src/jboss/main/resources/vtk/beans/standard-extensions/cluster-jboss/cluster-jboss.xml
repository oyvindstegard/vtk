<?xml version="1.0" encoding="utf-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd">

  <!-- Override bean "cluster.manager" defined in vtk/beans/vhost/cluster.xml -->
  <bean id="cluster.manager" class="vtk.cluster.JBossClusterManager" destroy-method="destroy">
    <constructor-arg name="clusterComponents" ref="cluster.components"/>
    <constructor-arg name="clusterId" value="${repositoryID}"/>
  </bean>

  <!-- Override bean "systemIndex" in vtk/beans/query.xml -->
  <bean id="systemIndex" class="vtk.repository.index.PropertySetIndexImpl">
    <property name="indexAccessor" ref="systemIndexAccessor"/>
    <property name="documentMapper" ref="documentMapper"/>
    <property name="initClusterRole" value="SLAVE" />
    <property name="clusterSharedStorage" value="${repository.index.clusterSharedStorage}" />
  </bean>
  
  <!-- Override bean "secondarySystemIndex" in vtk/beans/query.xml -->
  <bean id="secondarySystemIndex" class="vtk.repository.index.PropertySetIndexImpl">
    <property name="indexAccessor" ref="secondarySystemIndexAccessor"/>
    <property name="documentMapper" ref="documentMapper"/>
    <property name="closeAfterInit" value="true"/>
    <property name="initClusterRole" value="SLAVE" />
    <property name="clusterSharedStorage" value="${repository.index.clusterSharedStorage}" />
  </bean>

  <!-- Override bean "systemIndexAccessor" in vtk/beans/query.xml -->
  <bean id="systemIndexAccessor" class="vtk.repository.index.IndexManager">
    <property name="storageRootPath" value="${indexStorageRootPath}"/>
    <property name="storageId" value="property_index.${repository.index.updateLoggerId}"/>
    <property name="forceUnlock" value="${repository.index.clusterSharedStorage}" />
    <property name="searcherFactory" ref="searcherFactory"/>
    <property name="keepOldCommits" value="#{'${repository.index.clusterSharedStorage}'=='true' ? '5' : '0'}" />
    <property name="useSimpleLockFactory" value="${repository.index.clusterSharedStorage}" />
    <property name="writeLockTimeoutSeconds" value="30" />
    <property name="maxLockAcquireTimeOnShutdown" value="20"/>
  </bean>
  
  <!-- Override bean "secondarySystemIndexAccessor" in vtk/beans/query.xml -->
  <bean id="secondarySystemIndexAccessor" class="vtk.repository.index.IndexManager">
    <property name="storageRootPath" value="${indexStorageRootPath}"/>
    <property name="storageId" value="property_index.secondary.${repository.index.updateLoggerId}"/>
    <property name="forceUnlock" value="${repository.index.clusterSharedStorage}" />
    <property name="batchIndexingMode" value="true"/>
    <property name="keepOldCommits" value="#{'${repository.index.clusterSharedStorage}'=='true' ? '5' : '0'}" />
    <property name="useSimpleLockFactory" value="${repository.index.clusterSharedStorage}" />
    <property name="writeLockTimeoutSeconds" value="30" />
    <property name="maxLockAcquireTimeOnShutdown" value="20"/>
  </bean>
    
  <!-- Override and replace bean -->
  <bean id="cookieLinkStore.cache" class="vtk.util.cache.InfinispanSimpleCache">
    <constructor-arg name="name" value="cookieLinkStore.cache" />
    <constructor-arg name="timeoutSeconds" value="3600" />
    <constructor-arg name="updateTimeouts" value="true" />
  </bean>

  <!-- Override and replace bean -->
  <bean id="feide.requestIdStore" class="vtk.util.cache.InfinispanSimpleCache">
    <constructor-arg name="name" value="feide.requestIdStore" />
    <!-- Should be same timeout as sessions in general. -->
    <constructor-arg name="timeoutSeconds" value="1800" />
    <constructor-arg name="updateTimeouts" value="false" />
  </bean>

  <!-- Override and replace bean -->
  <bean id="saml.ieCookieStore.cache" class="vtk.util.cache.InfinispanSimpleCache">
    <constructor-arg name="name" value="saml.ieCookieStore.cache" />
    <constructor-arg name="timeoutSeconds" value="3600" />
    <constructor-arg name="updateTimeouts" value="true" />
  </bean>

  <!-- Override and replace bean -->
  <bean id="saml.requestIdStore" class="vtk.util.cache.InfinispanSimpleCache">
    <constructor-arg name="name" value="saml.requestIdStore" />
    <!-- Should be same timeout as sessions in general. -->
    <constructor-arg name="timeoutSeconds" value="1800" />
    <constructor-arg name="updateTimeouts" value="false" />
  </bean>

  <!-- Override and replace bean -->
  <bean id="tokenManagerCache" class="vtk.util.cache.InfinispanSimpleCache">
    <constructor-arg name="name" value="tokenManagerCache" />
    <constructor-arg name="timeoutSeconds" value="1800" />
    <constructor-arg name="updateTimeouts" value="true" />
  </bean>
  
  <!-- Override bean defined in 'vhost/common/vtk.xml' -->
  <bean id="spring.sessionRepository" class="vtk.util.web.SimpleCacheSessionRepository">
    <constructor-arg name="cache">
      <bean class="vtk.util.cache.InfinispanSimpleCache">
        <constructor-arg name="name" value="spring.sessionRepository.cache" />
        <constructor-arg name="timeoutSeconds" value="1800" />
        <constructor-arg name="updateTimeouts" value="true" />
      </bean>
    </constructor-arg>
  </bean>

</beans>

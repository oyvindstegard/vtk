# Installation

To set up a minimal version of the VTK CMS the following steps
are necessary:

1. Download and install Maven 3
   ( http://maven.apache.org/download.html )

2. Create a database using the DDL in the
   `src/main/sql/postgresql-schema.sql` (currently only PostgreSQL is
   supported, but HSQLDB has also been known to work in the past). The
   current PostgreSQL usage requires the language `plpgsql` to be
   installed in the database which can be installed with the following
   command `createlang plpgsql <database>`.

3. Set up the configuration. Configuration should be placed in the
   files `~/.vtk.properties` and `~/.vrtx.properties`
```
   indexStorageRootPath = [an empty directory for storing indices]
   jdbcUsername = [your JDBC user]
   jdbcPassword = [your JDBC password]
   repositoryDataDirectory = [an empty directory for storing files]
   repositoryTrashCanDirectory = [an empty directory for storing "deleted" files]
   repositoryRevisionDirectory = [an empty directory for storing file revisions]
   databaseURL = [your JDBC URL, e.g. jdbc:postgresql:my-user>]
```  
4. Run the command `mvn jetty:run` (standing in the project
   directory). 

5. You should now be able to access the web service on
   http://localhost:9322/ and the WebDAV service on
   http://localhost:9321/. 
   
   Log in as `root@localhost:fish` or user `user@localhost:pw`.

6. See the default configuration file
   `src/main/resources/vtk/beans/vtk.properties` for
   descriptions of the various configuration settings.

7. Custom bean definitions and overriding can be placed in the file
   `~/.vrtx-context.xml` (loaded if it exists).

8. Create `folder-templates`, `document-templates` and set up simple
   decorating in repository:

## Folder templates:
```
curl -s -uroot@localhost:fish -X MKCOL http://localhost:9321/vrtx/
curl -s -uroot@localhost:fish -X MKCOL http://localhost:9321/vrtx/folder-templates/
curl -s -uroot@localhost:fish -X MKCOL http://localhost:9321/vrtx/folder-templates/types/
curl -s -uroot@localhost:fish -X MKCOL http://localhost:9321/vrtx/folder-templates/types/article-listing/
curl -s -uroot@localhost:fish -X PROPPATCH http://localhost:9321/vrtx/folder-templates/types/article-listing/ \
     --data-binary @<(cat << EOF
<?xml version="1.0" encoding="utf-8" ?>
<D:propertyupdate xmlns:D="DAV:"
  xmlns:v="vrtx">
  <D:set>
    <D:prop>
      <v:collection-type>article-listing</v:collection-type>
    </D:prop>
  </D:set>
</D:propertyupdate>
EOF
)
curl -s -uroot@localhost:fish -X PUT http://localhost:9321/vrtx/folder-templates/config.txt \
     -H 'Content-Type: text/plain' --data-binary @<(cat << EOF
/ = types
EOF
)
```

## Document templates:
```
curl -s -uroot@localhost:fish -X MKCOL http://localhost:9321/vrtx/
curl -s -uroot@localhost:fish -X MKCOL http://localhost:9321/vrtx/doc-templates/
curl -s -uroot@localhost:fish -X MKCOL http://localhost:9321/vrtx/doc-templates/types/
curl -s -uroot@localhost:fish -X PUT http://localhost:9321/vrtx/doc-templates/types/article.html \
     -H 'Content-Type: application/json' --data-binary @<(cat << EOF
{
   "resourcetype": "structured-article",
   "properties":    {
      "title": "#title#",
      "showAdditionalContent": "true",
      "hideAdditionalContent": "false"
   }
}
EOF
)
curl -s -uroot@localhost:fish -X PUT http://localhost:9321/vrtx/doc-templates/config.txt \
     -H 'Content-Type: text/plain' --data-binary @<(cat << EOF
/ = types
EOF
)
```

## Decorating:
```
curl -s -uroot@localhost:fish -X MKCOL http://localhost:9321/vrtx/decorating/
curl -s -uroot@localhost:fish -X MKCOL http://localhost:9321/vrtx/decorating/templates/
curl -s -uroot@localhost:fish -X PUT http://localhost:9321/vrtx/decorating/templates/simple.html \
     -H 'Content-Type: text/html' --data-binary @<(cat << EOF
<!DOCTYPE html>
<html>
  <head>
    <title>\${document:title}</title>
    <!-- Include ugly CSS: -->
    <style type="text/css">
      body { background: brown; }
      h1 { background: pink; }
      div#vrtx-collections { background: yellow; }
    </style>
  </head>
  <body>
    <!-- This ugly HTML is generated by template /vrtx/decorating/simple.html -->
    <h1>${document:title}</h1>
    \${document:body}
    <hr>
    \${resource:manage-url}
  </body>
</html>
EOF
)
curl -s -uroot@localhost:fish -X PUT http://localhost:9321/vrtx/decorating/config.txt \
     -H 'Content-Type: text/plain' --data-binary @<(cat << EOF
/ = simple.html
/vrtx/decorating = NONE
EOF
)
```

## NOTE ON JBOSS

For determining the master node in a JBoss cluster a singleton service is used.
This special service is started by the file:

`src/main/resources/META-INF/services/org.jboss.msc.service.ServiceActivator`

The JBoss management code for singleton requires OSGi, and this breaks normal
`jetty:run`, so we have defined a special profile in `pom.xml` for it. Build with:
```
mvn -Dcontainer=jboss clean compile war:war
```
When running, include the following (e.g. as an import in `~/vrtx-context.xml`)
```
/vtk/beans/standard-extensions/cluster/cluster.jboss.xml
```

<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">

<beans>

  <!-- Html resource -->

  <bean id="htmlResourceTypeDefinition" class="org.vortikal.repository.resourcetype.PrimaryResourceTypeDefinitionImpl">
    <property name="name" value="html"/>
    <property name="namespace" ref="DEFAULT_NAMESPACE" />
    <property name="parentTypeDefinition" ref="textResourceTypeDefinition" />
    <property name="assertions">
      <list>
        <ref bean="contentTypeMatchesHtml" />
      </list>
    </property>
    <property name="propertyTypeDefinitions">
      <list>
        <ref bean="htmlDocTypePropDef" />
        <ref bean="htmlGuessedCharacterEncodingPropDef" />
        <ref bean="htmlCharacterEncodingPropDef" />
      </list>
    </property>
  </bean>

  <bean id="htmlDocTypePropDef" class="org.vortikal.repository.resourcetype.PropertyTypeDefinitionImpl">
    <property name="name" value="docType" />
    <property name="type" ref="TYPE_STRING" />
    <property name="protectionLevel" ref="PROTECTION_LEVEL_UNEDITABLE" />
    <property name="mandatory" value="false" />
    <property name="contentModificationEvaluator" ref="docTypeEvaluator" />
  </bean>

  <bean id="docTypeEvaluator" 
        class="org.vortikal.repository.resourcetype.property.DocTypeEvaluator" />



  <bean id="htmlGuessedCharacterEncodingPropDef"
        class="org.vortikal.repository.resourcetype.PropertyTypeDefinitionImpl">

    <property name="name" value="guessedCharacterEncoding" />
    <property name="type" ref="TYPE_STRING" />
    <property name="protectionLevel" ref="PROTECTION_LEVEL_UNEDITABLE" />
    <property name="mandatory" value="true" />
    <property name="createEvaluator" ref="htmlGuessedCharacterEncodingEvaluator" />
    <property name="contentModificationEvaluator" ref="htmlGuessedCharacterEncodingEvaluator" />
    <property name="defaultValue" ref="defaultTextResourceEncoding" />
  </bean>

  <bean id="htmlGuessedCharacterEncodingEvaluator" 
        class="org.vortikal.repository.resourcetype.property.HtmlCharacterEncodingEvaluator">
    <property name="defaultEncoding" value="iso-8859-1" />
  </bean>


  <!-- Overrides 'characterEncodingPropDef' in 'text' resource type -->
  <bean id="htmlCharacterEncodingPropDef"
        class="org.vortikal.repository.resourcetype.PropertyTypeDefinitionImpl">
    <property name="name" value="characterEncoding" />
    <property name="protectionLevel" ref="PROTECTION_LEVEL_UNEDITABLE" />
    <property name="mandatory" value="true" />
    <property name="createEvaluator" ref="characterEncodingEvaluator" />
    <property name="contentModificationEvaluator" ref="htmlCharacterEncodingEvaluator" />
    <property name="propertiesModificationEvaluator" ref="htmlCharacterEncodingEvaluator" />
  </bean>

  <bean id="htmlCharacterEncodingEvaluator"
        class="org.vortikal.repository.resourcetype.property.FirstMatchPropertyEvaluator">
    <property name="propertyDefinitions">
      <list>
        <ref bean="userSpecifiedCharacterEncodingPropDef" />
        <ref bean="htmlGuessedCharacterEncodingPropDef" />
      </list>
    </property>
  </bean>
  
  
  <!-- XXX
       a bit mysterious, but InvertAssertion (both types) must be wrapped to ensure that
       it is attempted 'matched' by the relevant service(s)...
       Will look into this behaviour later (may be due to handling in 'LinkConstructionHelperImpl')-->
  <bean id="docTypeIsHtml" class="org.vortikal.web.service.RepositoryShortcutOrAssertion">
    <property name="assertions">
      <list>
        <ref bean="docTypeIsNotXhtml" />
      </list>
    </property>    
  </bean>
  
  <bean id="docTypeIsNotXhtml" class="org.vortikal.web.service.InvertRepositoryAssertion" 
        parent="requestLocalRepositoryAware">
    <property name="assertion" ref="docTypeIsXHtml10" />
  </bean>
    
<!--  
  <bean id="docTypeIsNotXhtml10" class="org.vortikal.web.service.InvertAssertion" 
        parent="requestLocalRepositoryAware">
    <property name="assertion" ref="docTypeIsXHtml10" />
  </bean>
-->

</beans>



<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">

<beans>
  
  <!-- Repository -->

  <bean id="repository" class="org.vortikal.repositoryimpl.RepositoryImpl">
    <property name="id" value="${repositoryID}" />
    <property name="tokenManager" ref="tokenManager" />
    <property name="roleManager" ref="roleManager" />
    <property name="authorizationManager" ref="authorizationManager" />
    <property name="dao" ref="repository.backend" />
    <property name="lockManager" ref="lockManager" />
    <property name="propertyManager" ref="propertyManager" />
  </bean>

  <bean id="repository.backend" class="org.vortikal.repositoryimpl.dao.Cache">
    <property name="maxItems" value="${resourceCacheSize}" />
    <property name="wrappedAccessor" ref="repository.database" />
  </bean>

  <bean id="repository.dataSource" class="org.apache.commons.dbcp.BasicDataSource"
        destroy-method="close">
    <property name="driverClassName" value="${databaseDriver}" />
    <property name="maxActive" value="${maxDatabaseConnections}" />
    <property name="url" value="${databaseURL}" />
    <property name="username" value="${jdbcUsername}" />
    <property name="password"  value="${jdbcPassword}" />
    <property name="defaultAutoCommit" value="false" />
  </bean>


  <bean id="repository.database" class="org.vortikal.repositoryimpl.dao.JDBCClient">
    <property name="dataSource" ref="repository.dataSource" />
    <property name="contentStore" ref="repository.contentStore" />
    <property name="propertyManager" ref="propertyManager" />
    <property name="authorizationManager" ref="authorizationManager" />
    <property name="principalManager" ref="principalManager" />
  </bean>

  <bean id="repository.indexDataAccessor" class="org.vortikal.repositoryimpl.dao.IndexDataAccessorImpl">
    <property name="dataSource" ref="repository.dataSource" />
    <property name="propertyManager" ref="propertyManager" />
    <property name="principalManager" ref="principalManager" />
  </bean>

  <bean id="repository.contentStore" 
        class="org.vortikal.repositoryimpl.dao.SimpleFileSystemContentStore">
    <property name="urlEncodeFileNames" value="${urlEncodeFileNames}" />
    <property name="repositoryDataDirectory" value="${repositoryDataDirectory}" />
  </bean>

  <bean id="repository.requestLocal" class="org.vortikal.web.RequestLocalRepository">
    <property name="repository" ref="repository"/>
  </bean>

  <bean id="lockManager" class="org.vortikal.repositoryimpl.LockManager">
    <property name="dao" ref="repository.backend" />
  </bean>

  <bean id="valueFactory" class="org.vortikal.repository.resourcetype.ValueFactoryImpl">
    <property name="principalManager" ref="principalManager"/>
    <property name="dateFormats">
      <list>
        <value>dd.MM.yyyy HH:mm:ss</value>
        <value>dd.MM.yyyy HH:mm</value>
        <value>dd.MM.yyyy</value>
      </list>  
    </property>
  </bean>

  <bean id="propertyManager" class="org.vortikal.repositoryimpl.PropertyManagerImpl">
    <!-- Hack fix for circular deps. problem -->
    <property name="lazyInit" value="true" />

    <property name="authorizationManager" ref="authorizationManager" />
    <property name="principalManager" ref="principalManager" />
    <property name="roleManager" ref="roleManager" />
    <property name="valueFactory" ref="valueFactory"/>
    <property name="contentStore" ref="repository.contentStore"/>
    <property name="rootResourceTypeDefinition" ref="abstractResourceResourceTypeDefinition"/>
  </bean>

  <bean id="authorizationManager" class="org.vortikal.repositoryimpl.AuthorizationManager">
    <property name="readOnly" value="${repositoryReadOnly}" />
    <property name="principalManager" ref="principalManager" />
    <property name="lockManager" ref="lockManager" />
    <property name="roleManager" ref="roleManager" />
    <property name="dao" ref="repository.backend" />
  </bean>

  <!-- Quartz scheduled jobs -->

  <bean id="repository.schedulerFactory"
        class="org.springframework.scheduling.quartz.SchedulerFactoryBean">
    <property name="triggers">
      <list>
        <ref local="repository.unlockSimpleTrigger"/>
      </list>
    </property>
  </bean>


  <bean id="repository.unlockSimpleTrigger"
        class="org.springframework.scheduling.quartz.SimpleTriggerBean">
    <property name="jobDetail">
      <!-- see the example of method invoking job above -->    
      <ref bean="repository.cleanupLocksJobDetail"/>
    </property>
    <property name="startDelay">
      <!-- 60 seconds -->
      <value>60000</value>
    </property>
    <property name="repeatInterval">
      <!-- repeat every 600 seconds -->
      <value>600000</value>
    </property>
  </bean>

  <bean id="repository.cleanupLocksJobDetail" 
        class="org.vortikal.scheduling.quartz.VortikalMethodInvokingJobDetailFactoryBean">
    <property name="group" value="repository" />
    <property name="targetObject"><ref bean="repository.database"/></property>
    <property name="targetMethod"><value>deleteExpiredLocks</value></property>
  </bean>


</beans>

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">

<beans>
  <bean id="queryParser"
        class="org.vortikal.repositoryimpl.query.parser.QueryParser" />

<!--  <bean id="queryManager"
        class="org.vortikal.repositoryimpl.query.parser.QueryManager">
    <property name="parser" ref="queryParser" />
    <property name="searcher" ref="searcher" />
  </bean>
-->

  <!-- Database data accessor for indexing system -->
  <bean id="indexDataAccessor" class="org.vortikal.repositoryimpl.dao.IndexDataAccessorImpl">
    <property name="propertyManager" ref="propertyManager"/>
    <property name="principalManager" ref="principalManager"/>
    <property name="dataSource" ref="repository.dataSource"/>
  </bean>

  <!-- Document mapper -->
  <bean id="documentMapper" class="org.vortikal.repositoryimpl.query.DocumentMapper">
    <property name="propertyManager" ref="propertyManager"/>
    <property name="valueFactory" ref="valueFactory"/>
  </bean>

  <!-- A Lucene index instance. Manages low-level access. -->
  <bean id="newLuceneSystemIndex" class="org.vortikal.repositoryimpl.query.LuceneIndex">
    <property name="primaryIndexPath" value="${newSystemIndexPath}"/>
    <property name="forceUnlock" value="true"/>
  </bean>

  <!-- Property set index based on a single Lucene index instance. -->
  <bean id="newSystemIndex" class="org.vortikal.repositoryimpl.query.PropertySetIndexImpl">
    <property name="index" ref="newLuceneSystemIndex"/>
    <property name="documentMapper" ref="documentMapper"/>
    <property name="propertyManager" ref="propertyManager"/>
  </bean>

  <!-- Factory for building Lucene queries. -->
  <bean id="queryBuilderFactory"
        class="org.vortikal.repositoryimpl.query.QueryBuilderFactoryImpl">
    <property name="propertyManager" ref="propertyManager"/>
    <property name="indexAccessor" ref="newLuceneSystemIndex"/>
  </bean>

  <!-- Searcher -->
  <bean id="newSystemIndexSearcher"
        class="org.vortikal.repositoryimpl.query.SearcherImpl">
    <property name="indexAccessor" ref="newLuceneSystemIndex"/>
    <property name="documentMapper" ref="documentMapper"/>
    <property name="queryBuilderFactory" ref="queryBuilderFactory"/>

    <!--
    <property name="queryAuthorizationManager" ref="queryAuthorizationManager"/>
    -->
  </bean>

  <!-- Perform incremental updates on property set index from resource changes. -->
  <bean id="newSystemIndexUpdater" 
        class="org.vortikal.repositoryimpl.query.observation.PropertySetIndexUpdater">
    <property name="index" ref="newSystemIndex"/>
    <property name="notifier" ref="repository.resourceChangeNotifier"/>
    <property name="indexDataAccessor" ref="indexDataAccessor"/>
  </bean>

  <!-- Simple re-indexer for propety set index 'newSystemIndex'. -->
  <bean id="newSystemIndexReindexer" class="org.vortikal.repositoryimpl.query.Reindexer">
    <property name="indexDataAccessor" ref="indexDataAccessor"/>
    <property name="index" ref="newSystemIndex"/>
  </bean>
</beans>

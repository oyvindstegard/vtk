<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">

<beans>
  <bean id="queryParser"
        class="org.vortikal.repositoryimpl.query.parser.QueryParser">
    <constructor-arg ref="propertyManager" />
  </bean>


  <bean id="queryManager" class="org.vortikal.repositoryimpl.query.parser.QueryManager">
    <property name="parser" ref="queryParser" />
    <property name="searcher" ref="newSystemIndexSearcher" />
    <property name="propertyManager" ref="propertyManager" />
    <property name="queryStringProcessor" ref="queryStringProcessor" />
  </bean>


  <bean id="queryStringProcessor"
        class="org.vortikal.repositoryimpl.query.parser.QueryStringProcessor">
    <property name="expressionEvaluators">
      <list>
        <bean class="org.vortikal.repositoryimpl.query.parser.CurrentDateExpressionEvaluator" />
        <bean class="org.vortikal.repositoryimpl.query.parser.CurrentURIExpressionEvaluator"
              parent="requestLocalRepositoryAware" />
      </list>
    </property>
  </bean>

  <!-- Document mapper -->
  <bean id="documentMapper" class="org.vortikal.repositoryimpl.query.DocumentMapper">
    <property name="propertyManager" ref="propertyManager"/>
    <property name="valueFactory" ref="valueFactory"/>
  </bean>

  <!-- A Lucene index instance. Manages low-level access. -->
  <bean id="newLuceneSystemIndex" class="org.vortikal.repositoryimpl.query.LuceneIndex">
    <property name="primaryIndexPath" value="${newSystemIndexPath}"/>
    <property name="forceUnlock" value="true"/>
    <property name="maxLockAcquireTimeOnShutdown" value="30"/>
  </bean>

  <!-- Property set index based on a single Lucene index instance. -->
  <bean id="newSystemIndex" class="org.vortikal.repositoryimpl.query.PropertySetIndexImpl">
    <property name="index" ref="newLuceneSystemIndex"/>
    <property name="documentMapper" ref="documentMapper"/>
    <property name="propertyManager" ref="propertyManager"/>
  </bean>

  <!-- Factory for building Lucene queries. -->
  <bean id="queryBuilderFactory"
        class="org.vortikal.repositoryimpl.query.QueryBuilderFactoryImpl">
    <property name="propertyManager" ref="propertyManager"/>
    <property name="indexAccessor" ref="newLuceneSystemIndex"/>
  </bean>

  <!-- Searcher -->
  <bean id="newSystemIndexSearcher"
        class="org.vortikal.repositoryimpl.query.SearcherImpl">
    <property name="indexAccessor" ref="newLuceneSystemIndex"/>
    <property name="documentMapper" ref="documentMapper"/>
    <property name="queryBuilderFactory" ref="queryBuilderFactory"/>
    <property name="maxAllowedHitsPerQuery" value="50000"/>

    <!--
    <property name="queryAuthorizationManager" ref="queryAuthorizationManager"/>
    -->
  </bean>

<!--   <bean id="queryResultAuthorizationManager" -->
<!--         class="org.vortikal.repositoryimpl.query.security.DatabaseQueryResultAuthorizationManagaer"> -->
<!--     <property name="principalManager" ref="principalManager"/> -->
<!--     <property name="tokenManager" ref="tokenManager"/> -->
<!--     <property name="indexDataAccessor" ref="repository.indexDataAccessor"/> -->
<!--   </bean> -->

  <!-- Perform incremental updates on property set index from resource changes. -->
  <bean id="newSystemIndexUpdater" 
        class="org.vortikal.repositoryimpl.query.observation.PropertySetIndexUpdater">
    <property name="index" ref="newSystemIndex"/>
    <property name="notifier" ref="repository.resourceChangeNotifier"/>
    <property name="indexDataAccessor" ref="repository.indexDataAccessor"/>
  </bean>

  <!-- Simple re-indexer for propety set index 'newSystemIndex'. -->
  <bean id="newSystemIndexReindexer" class="org.vortikal.repositoryimpl.query.Reindexer">
    <property name="indexDataAccessor" ref="repository.indexDataAccessor"/>
    <property name="index" ref="newSystemIndex"/>
  </bean>
</beans>
